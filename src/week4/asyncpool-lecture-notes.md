# AsyncPool ‚Äî –ü–∞—Ç—Ç–µ—Ä–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—É–ª –æ–±—ä–µ–∫—Ç–æ–≤

## –û–±–∑–æ—Ä

AsyncPool ‚Äî —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Å–æ–±–æ–π **–ø—É–ª –æ–±—ä–µ–∫—Ç–æ–≤** (Object Pool), –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ Node.js. –û–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤) –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∏—Ö –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞

- **–•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é** ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏ –∑–∞–Ω—è—Ç—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–∂–∏–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ Promise, –∫–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∞—Ü–∏—è** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É

---

## –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—É–ª?

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —á–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:

- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–¢—è–∂–µ–ª—ã–µ –æ–±—ä–µ–∫—Ç—ã** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–∏—Ö –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—É–ª–∞**: –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∫–æ–ª–±–µ–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Promise-–∫–æ–Ω—Ç—Ä–∞–∫—Ç** –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ AsyncPool

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```javascript
class AsyncPool {
  // –ö–æ–ª–ª–µ–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏–º—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
  instances = [];

  // –§–ª–∞–≥–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: true = —Å–≤–æ–±–æ–¥–µ–Ω, false = –∑–∞–Ω—è—Ç
  free = [];

  // –û—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞—é—â–∏—Ö Promise
  queue = [];

  // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–µ–∫—É—â–∏–π –∏–Ω—Å—Ç–∞–Ω—Å –¥–ª—è –≤—ã–¥–∞—á–∏
  current = 0;

  // –†–∞–∑–º–µ—Ä –ø—É–ª–∞
  size = 0;

  // –°—á–µ—Ç—á–∏–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö (—Å–≤–æ–±–æ–¥–Ω—ã—Ö) –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
  available = 0;
}
```

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      AsyncPool (size: 10)           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ instances: [obj0...obj9]            ‚îÇ
‚îÇ free:      [T,T,F,F,T,T,T,T,T,T]    ‚îÇ
‚îÇ available: 8                        ‚îÇ
‚îÇ queue:     [{resolve, timer}, ...]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üë                    ‚Üì
    release()            getInstance()
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ AsyncPool

### 1. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
class AsyncPool {
  constructor(factory, size) {
    this.size = size;
    this.available = size;
    this.current = 0;
    this.instances = new Array(size);
    this.free = new Array(size);
    this.queue = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–ª–∞–≥–æ–≤ "—Å–≤–æ–±–æ–¥–µ–Ω"
    for (let i = 0; i < size; i++) {
      this.free[i] = true;
      // –í—ã–∑–æ–≤ —Ñ–∞–±—Ä–∏–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
      this.instances[i] = factory(i);
    }
  }
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

- **–§–∞–±—Ä–∏–∫–∞ –≤–º–µ—Å—Ç–æ –≥–æ—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤** ‚Äî –ø—É–ª —Å–∞–º —Å–æ–∑–¥–∞–µ—Ç –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é-—Ñ–∞–±—Ä–∏–∫—É
- **–†–∞–∑–º–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω** ‚Äî –º–∞—Å—Å–∏–≤—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å—Ä–∞–∑—É –Ω–∞ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä
- **–°—á–µ—Ç—á–∏–∫ available** ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞ –º–∞—Å—Å–∏–≤–∞

### 2. –ú–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–∞ (getInstance)

```javascript
async getInstance() {
  // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö ‚Äî —Å—Ç–∞–≤–∏–º Promise –≤ –æ—á–µ—Ä–µ–¥—å
  if (this.available === 0) {
    return new Promise((resolve) => {
      this.queue.push(resolve);
    });
  }

  // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å
  return this.next();
}
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏** ‚Äî –µ—Å–ª–∏ `available === 0`, —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–æ–º–∏—Å –∏ –µ–≥–æ `resolve` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** ‚Äî –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –ø–æ–ª—É—á–∏—Ç –∏–Ω—Å—Ç–∞–Ω—Å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç —Ä–µ—Å—É—Ä—Å
3. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞** ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `next()` –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç–∞–Ω—Å–∞

### 3. –ü–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (next)

```javascript
next() {
  let instance = null;
  let free = false;

  // –¶–∏–∫–ª –ø–æ–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞
  while (!free) {
    instance = this.instances[this.current];
    free = this.free[this.current];

    // –¶–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è
    this.current++;
    if (this.current >= this.size) {
      this.current = 0;
    }

    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π ‚Äî –ø–æ–º–µ—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    if (instance && free) {
      this.free[this.current] = false;
      this.available--;
      return instance;
    }
  }
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥** ‚Äî —É–∫–∞–∑–∞—Ç–µ–ª—å `current` –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø–æ –∫—Ä—É–≥—É (Round-Robin)
- **–ì–∞—Ä–∞–Ω—Ç–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** ‚Äî —Ü–∏–∫–ª –±–µ–∑–æ–ø–∞—Å–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `next()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `available > 0`
- **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** ‚Äî —Ñ–ª–∞–≥ `free` –º–µ–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, —Å—á–µ—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è

### 4. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–∞ (release)

```javascript
release(instance) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∏–Ω—Å—Ç–∞–Ω—Å –≤ –ø—É–ª–µ
  const index = this.instances.indexOf(instance);
  if (index === -1) {
    throw new Error('Attempting to release an instance not managed by this pool');
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –ø—ã—Ç–∞—é—Ç—Å—è –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —É–∂–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å
  if (this.free[index]) {
    throw new Error('Attempting to release an already free instance');
  }

  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –æ—Ç–¥–∞–µ–º –∏–º –Ω–∞–ø—Ä—è–º—É—é
  if (this.queue.length > 0) {
    const resolve = this.queue.shift();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç–∞–Ω—Å –≤ –ø—Ä–æ–º–∏—Å —á–µ—Ä–µ–∑ setImmediate
    setImmediate(() => {
      resolve(instance);
    });

    // –ò–Ω—Å—Ç–∞–Ω—Å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–Ω—è—Ç—ã–º (–ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –Ω–æ–≤–æ–º—É –≤–ª–∞–¥–µ–ª—å—Ü—É)
    return;
  }

  // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî –ø–æ–º–µ—á–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–º
  this.available++;
  this.free[index] = true;
}
```

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–∞** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤–µ—Ä–Ω—É—Ç—å "—á—É–∂–∏–µ" –æ–±—ä–µ–∫—Ç—ã
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–∞–≥–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
3. **–ü—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ–∂–∏–¥–∞—é—â–∏–º** ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –æ—á–µ—Ä–µ–¥—å, –∏–Ω—Å—Ç–∞–Ω—Å —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é
4. **setImmediate –¥–ª—è resolve** ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –∫–≤–∞–Ω—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ event loop, –∏–∑–±–µ–≥–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω —Ç–∞–π–º–∞—É—Ç?

–í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –Ω–µ–ª—å–∑—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∂–¥–∞—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞:

- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∞–Ω–∏–π** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç deadlock-—Å–∏—Ç—É–∞—Ü–∏–π
- **–ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è
- **Graceful degradation** ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é

### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞

```javascript
class AsyncPool {
  constructor(factory, options) {
    this.size = options.size;
    this.timeout = options.timeout; // –¢–∞–π–º–∞—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    this.available = this.size;
    this.current = 0;
    this.instances = new Array(this.size);
    this.free = new Array(this.size);
    this.queue = [];

    for (let i = 0; i < this.size; i++) {
      this.free[i] = true;
      this.instances[i] = factory(i);
    }
  }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±—ä–µ–∫—Ç `options`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `timeout` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è

### –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π getInstance —Å —Ç–∞–π–º–µ—Ä–æ–º

```javascript
async getInstance() {
  if (this.available === 0) {
    return new Promise((resolve, reject) => {
      // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–∏—Å–∞
      const timer = setTimeout(() => {
        reject(new Error('Pool timeout exceeded'));
      }, this.timeout);

      // –í –æ—á–µ—Ä–µ–¥—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º resolve –∏ timer
      this.queue.push({ resolve, timer });
    });
  }

  return this.next();
}
```

**–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞** ‚Äî `setTimeout` –≤—ã–∑–æ–≤–µ—Ç `reject` —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –æ—á–µ—Ä–µ–¥–∏** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ `resolve`, –∏ `timer` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–∏
3. **–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞** ‚Äî –µ—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É

### –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π release

```javascript
release(instance) {
  const index = this.instances.indexOf(instance);
  if (index === -1) {
    throw new Error('Attempting to release an instance not managed by this pool');
  }

  if (this.free[index]) {
    throw new Error('Attempting to release an already free instance');
  }

  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ ‚Äî –æ—Ç–¥–∞–µ–º –∏–º
  if (this.queue.length > 0) {
    const { resolve, timer } = this.queue.shift();

    // –í–ê–ñ–ù–û: –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä, —Ç–∞–∫ –∫–∞–∫ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ
    clearTimeout(timer);

    setImmediate(() => {
      resolve(instance);
    });

    return;
  }

  // –ü–æ–º–µ—á–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–º
  this.available++;
  this.free[index] = true;
}
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**

- **clearTimeout(timer)** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–∞
- **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏** ‚Äî `shift()` —É–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞—è –ø–∞–º—è—Ç—å

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AbortSignal

### –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –æ—Ç–º–µ–Ω–µ –æ–ø–µ—Ä–∞—Ü–∏–π

AbortSignal ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Web API –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```javascript
async getInstance() {
  if (this.available === 0) {
    return new Promise((resolve, reject) => {
      // –°–æ–∑–¥–∞–µ–º AbortSignal —Å —Ç–∞–π–º–∞—É—Ç–æ–º
      const signal = AbortSignal.timeout(this.timeout);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
      const listener = () => {
        // –û—à–∏–±–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ signal.reason
        reject(signal.reason);
      };

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ abort
      signal.addEventListener('abort', listener);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≤—Å–µ —Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      this.queue.push({ resolve, signal, listener });
    });
  }

  return this.next();
}
```

### –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏

```javascript
release(instance) {
  const index = this.instances.indexOf(instance);
  if (index === -1) {
    throw new Error('Attempting to release an instance not managed by this pool');
  }

  if (this.free[index]) {
    throw new Error('Attempting to release an already free instance');
  }

  if (this.queue.length > 0) {
    const { resolve, signal, listener } = this.queue.shift();

    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
    signal.removeEventListener('abort', listener);

    setImmediate(() => {
      resolve(instance);
    });

    return;
  }

  this.available++;
  this.free[index] = true;
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ AbortSignal:**

- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è** ‚Äî –µ–¥–∏–Ω—ã–π API –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** ‚Äî —Ç–∞–π–º–∞—É—Ç –≤—Å—Ç—Ä–æ–µ–Ω –≤ —Å–∏–≥–Ω–∞–ª
- **Garbage Collection** ‚Äî –ø–æ—Å–ª–µ `removeEventListener` –∏ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏—Ç—å listener** ‚Äî EventTarget —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
- **–ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** ‚Äî —Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ —Å setTimeout

---

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –§–∞–±—Ä–∏–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```javascript
// –§–∞–±—Ä–∏–∫–∞ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
const connectionFactory = (index) => {
  return {
    id: `connection-${index}`,
    query: async (sql) => {
      console.log(`[${this.id}] Executing: ${sql}`);
      // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
      return new Promise((resolve) => {
        setTimeout(() => resolve({ rows: [] }), 100);
      });
    },
    close: () => {
      console.log(`[${this.id}] Closed`);
    }
  };
};

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ —Å 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
const pool = new AsyncPool(connectionFactory, { size: 10, timeout: 3000 });
```

### –ü—Ä–∏–º–µ—Ä 2: –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–∞

```javascript
const pool = new AsyncPool(connectionFactory, 10);
const connections = [];

// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 12 –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–µ—Ä–µ –ø—É–ª–∞ 10
for (let i = 0; i < 12; i++) {
  (async () => {
    try {
      const conn = await pool.getInstance();
      console.log(`Got instance: ${conn.id}`);

      // –ü–µ—Ä–≤—ã–µ –¥–≤–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–∑–¥–Ω–µ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
      if (i < 2) {
        connections.push(conn);
      } else {
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
        pool.release(conn);
      }
    } catch (error) {
      console.error(`Error: ${error.message}`);
    }
  })();
}

// –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–µ—Ä–≤—ã–π
setTimeout(() => {
  console.log('Releasing connection 0');
  pool.release(connections[0]);
}, 2000);

// –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –≤—Ç–æ—Ä–æ–π
setTimeout(() => {
  console.log('Releasing connection 1');
  pool.release(connections[1]);
}, 5000);
```

**–í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**

```
Got instance: connection-0
Got instance: connection-1
Got instance: connection-2
Got instance: connection-3
Got instance: connection-4
Got instance: connection-5
Got instance: connection-6
Got instance: connection-7
Got instance: connection-8
Got instance: connection-9
Releasing connection 0
Got instance: connection-0   // 11-–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏–ª –æ—Å–≤–æ–±–æ–¥–∏–≤—à–∏–π—Å—è –∏–Ω—Å—Ç–∞–Ω—Å
Releasing connection 1
Got instance: connection-1   // 12-–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏–ª –æ—Å–≤–æ–±–æ–¥–∏–≤—à–∏–π—Å—è –∏–Ω—Å—Ç–∞–Ω—Å
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

1. –ü–µ—Ä–≤—ã–µ 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞—é—Ç –∏–Ω—Å—Ç–∞–Ω—Å—ã (–ø—É–ª –∑–∞–ø–æ–ª–Ω–µ–Ω)
2. –ó–∞–ø—Ä–æ—Å—ã 11 –∏ 12 —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å (`available === 0`)
3. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è `connection-0`, –æ–Ω —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è 11-–º—É –∑–∞–ø—Ä–æ—Å—É
4. –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è `connection-1`, –æ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è 12-–º—É –∑–∞–ø—Ä–æ—Å—É

### –ü—Ä–∏–º–µ—Ä 3: –†–∞–±–æ—Ç–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º

```javascript
const pool = new AsyncPool(connectionFactory, {
  size: 10,
  timeout: 3000  // –ú–∞–∫—Å–∏–º—É–º 3 —Å–µ–∫—É–Ω–¥—ã –æ–∂–∏–¥–∞–Ω–∏—è
});

const connections = [];

for (let i = 0; i < 12; i++) {
  (async () => {
    try {
      const conn = await pool.getInstance();
      console.log(`[${i}] Got instance: ${conn.id}`);

      if (i < 2) {
        connections.push(conn);
      } else {
        pool.release(conn);
      }
    } catch (error) {
      console.error(`[${i}] Error: ${error.message}`);
    }
  })();
}

// –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã (–ø–æ–∑–∂–µ —Ç–∞–π–º–∞—É—Ç–∞!)
setTimeout(() => {
  console.log('Releasing connection 0');
  pool.release(connections[0]);
}, 4000);

setTimeout(() => {
  console.log('Releasing connection 1');
  pool.release(connections[1]);
}, 5000);
```

**–í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**

```
[0] Got instance: connection-0
[1] Got instance: connection-1
[2] Got instance: connection-2
[3] Got instance: connection-3
[4] Got instance: connection-4
[5] Got instance: connection-5
[6] Got instance: connection-6
[7] Got instance: connection-7
[8] Got instance: connection-8
[9] Got instance: connection-9
[10] Error: Pool timeout exceeded     // –¢–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
Releasing connection 0                 // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
[11] Got instance: connection-0        // 12-–π –∑–∞–ø—Ä–æ—Å –¥–æ–∂–¥–∞–ª—Å—è
Releasing connection 1
```

**–ê–Ω–∞–ª–∏–∑:**

- –ó–∞–ø—Ä–æ—Å 11 (–∏–Ω–¥–µ–∫—Å 10) –∂–¥–µ—Ç 3 —Å–µ–∫—É–Ω–¥—ã ‚Üí —Ç–∞–π–º–∞—É—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É
- –ó–∞–ø—Ä–æ—Å 12 (–∏–Ω–¥–µ–∫—Å 11) –∂–¥–µ—Ç 3 —Å–µ–∫—É–Ω–¥—ã ‚Üí –≤—Å–µ –µ—â–µ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Üí —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Å

---

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—É–ª–∞

### 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—É–ª–∞

–ú–æ–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—É–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —Å–≤–µ—Ä—Ö –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞:

```javascript
class DynamicAsyncPool extends AsyncPool {
  constructor(factory, options) {
    super(factory, options);
    this.maxSize = options.maxSize || this.size * 2;
    this.factory = factory;
  }

  async getInstance() {
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö, –Ω–æ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç maxSize ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
    if (this.available === 0 && this.instances.length < this.maxSize) {
      const newInstance = this.factory(this.instances.length);
      this.instances.push(newInstance);
      this.free.push(false);
      this.size++;
      return newInstance;
    }

    return super.getInstance();
  }

  release(instance) {
    const index = this.instances.indexOf(instance);

    // –ï—Å–ª–∏ –∏–Ω—Å—Ç–∞–Ω—Å —Å–≤–µ—Ä—Ö –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî —É–¥–∞–ª—è–µ–º
    if (index >= options.size && this.queue.length === 0) {
      this.instances.splice(index, 1);
      this.free.splice(index, 1);
      this.size--;

      // –í—ã–∑—ã–≤–∞–µ–º cleanup –µ—Å–ª–∏ –µ—Å—Ç—å
      if (instance.close) {
        instance.close();
      }

      return;
    }

    super.release(instance);
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** ‚Äî –ø—É–ª —Ä–∞—Å—Ç–µ—Ç –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- **–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** ‚Äî –ª–∏—à–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞** ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä `maxSize` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ add –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤

```javascript
add(instance) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Å—Ç–∞–Ω—Å –Ω–µ –≤ –ø—É–ª–µ
  if (this.instances.indexOf(instance) !== -1) {
    throw new Error('Instance already in pool');
  }

  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ ‚Äî —Å—Ä–∞–∑—É –æ—Ç–¥–∞–µ–º –∏–º
  if (this.queue.length > 0) {
    const { resolve, timer } = this.queue.shift();
    clearTimeout(timer);

    setImmediate(() => {
      resolve(instance);
    });

    return;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—É–ª
  this.instances.push(instance);
  this.free.push(true);
  this.size++;
  this.available++;
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**

- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω—Å—Ç–∞–Ω—Å—ã –∏–∑–≤–Ω–µ
- –ì–∏–±–∫–æ—Å—Ç—å –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–º –ø—É–ª–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –æ–±—ä–µ–∫—Ç–æ–≤

---

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ —Ç–µ—Ä–º–∏–Ω—ã

### Round-Robin (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —É–∫–∞–∑–∞—Ç–µ–ª—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ AsyncPool:**
```javascript
this.current++;
if (this.current >= this.size) {
  this.current = 0;  // –í–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—É
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ "–≥–æ–ª–æ–¥–∞–Ω–∏—è" –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Promise-based –∫–æ–Ω—Ç—Ä–∞–∫—Ç

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Promise –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞.

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–ª–±–µ–∫–∞–º–∏:**

```javascript
// –ö–æ–ª–±–µ–∫-—Å—Ç–∏–ª—å (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
pool.getInstance((err, instance) => {
  if (err) return console.error(err);
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ instance
});

// Promise-—Å—Ç–∏–ª—å (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
try {
  const instance = await pool.getInstance();
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ instance
} catch (error) {
  console.error(error);
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Promise:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ async/await —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ try/catch
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (Promise.all, Promise.race)

### Event Loop –∏ setImmediate

**–ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å setImmediate?**

```javascript
// –ë–ï–ó setImmediate ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
resolve(instance);
// resolve –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—É—é —Ü–µ–ø–æ—á–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

// –° setImmediate ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –∫–≤–∞–Ω—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
setImmediate(() => {
  resolve(instance);
});
// –î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ event loop –ø–æ–ª—É—á–∞—Ç —à–∞–Ω—Å –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
```

**–§–∞–∑—ã Event Loop:**
```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ>‚îÇ           timers          ‚îÇ ‚Äî setTimeout, setInterval
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îÇ     pending callbacks     ‚îÇ ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–ª–±–µ–∫–∏
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îÇ       idle, prepare       ‚îÇ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ   incoming:   ‚îÇ
‚îÇ  ‚îÇ           poll            ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  connections, ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ   data, etc.  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îÇ           check           ‚îÇ ‚Äî setImmediate
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚î§      close callbacks      ‚îÇ ‚Äî socket.on('close', ...)
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

setImmediate –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–∑–µ **check**, –ø–æ–∑–≤–æ–ª—è—è –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ü–∏—è–º –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è.

---

## –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ

### –û—à–∏–±–∫–∞ 1: –ó–∞–±—ã–ª–∏ –≤—ã–∑–≤–∞—Ç—å release

```javascript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const conn = await pool.getInstance();
await conn.query('SELECT * FROM users');
// –ó–∞–±—ã–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –≤ –ø—É–ª ‚Äî —É—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤!

// –ü–†–ê–í–ò–õ–¨–ù–û
const conn = await pool.getInstance();
try {
  await conn.query('SELECT * FROM users');
} finally {
  pool.release(conn);  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
}
```

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try/finally –∏–ª–∏ –æ–±–µ—Ä–Ω—É—Ç—å –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥:

```javascript
async withInstance(callback) {
  const instance = await this.getInstance();
  try {
    return await callback(instance);
  } finally {
    this.release(instance);
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
await pool.withInstance(async (conn) => {
  return await conn.query('SELECT * FROM users');
});
```

### –û—à–∏–±–∫–∞ 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ

```javascript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const conn = await pool.getInstance();
const savedRef = conn;  // –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ —Å—Å—ã–ª–∫—É

pool.release(conn);
// ... –ø–æ–∑–∂–µ ...
pool.release(savedRef);  // Error: already free instance
```

**–ó–∞—â–∏—Ç–∞ –≤ –∫–æ–¥–µ:**
```javascript
if (this.free[index]) {
  throw new Error('Attempting to release an already free instance');
}
```

### –û—à–∏–±–∫–∞ 3: –í–æ–∑–≤—Ä–∞—Ç "—á—É–∂–æ–≥–æ" –∏–Ω—Å—Ç–∞–Ω—Å–∞

```javascript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const externalConn = createConnection();
pool.release(externalConn);  // Error: not managed by this pool
```

**–ó–∞—â–∏—Ç–∞ –≤ –∫–æ–¥–µ:**
```javascript
const index = this.instances.indexOf(instance);
if (index === -1) {
  throw new Error('Attempting to release an instance not managed by this pool');
}
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø—É–ª–∞

```javascript
// –§–æ—Ä–º—É–ª–∞ –¥–ª—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î:
// connections = ((core_count * 2) + effective_spindle_count)

const cpuCount = require('os').cpus().length;
const poolSize = (cpuCount * 2) + 1;

const pool = new AsyncPool(dbConnectionFactory, {
  size: poolSize,
  timeout: 5000
});
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—É–ª–∞

```javascript
class MonitoredAsyncPool extends AsyncPool {
  getStats() {
    return {
      size: this.size,
      available: this.available,
      inUse: this.size - this.available,
      queueLength: this.queue.length,
      utilizationPercent: ((this.size - this.available) / this.size * 100).toFixed(2)
    };
  }

  logStats() {
    const stats = this.getStats();
    console.log(`Pool: ${stats.inUse}/${stats.size} in use, ${stats.queueLength} waiting, ${stats.utilizationPercent}% utilization`);
  }
}
```

### 3. Graceful shutdown

```javascript
class GracefulAsyncPool extends AsyncPool {
  async drain() {
    // –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
    while (this.available < this.size) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã
    for (const instance of this.instances) {
      if (instance.close) {
        await instance.close();
      }
    }

    this.instances = [];
    this.free = [];
    this.size = 0;
    this.available = 0;
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
process.on('SIGTERM', async () => {
  console.log('Draining pool...');
  await pool.drain();
  process.exit(0);
});
```

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏

### AsyncPool vs Semaphore

```javascript
// –°–µ–º–∞—Ñ–æ—Ä ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
class Semaphore {
  constructor(max) {
    this.max = max;
    this.current = 0;
    this.queue = [];
  }

  async acquire() {
    if (this.current < this.max) {
      this.current++;
      return;
    }

    await new Promise(resolve => this.queue.push(resolve));
  }

  release() {
    if (this.queue.length > 0) {
      const resolve = this.queue.shift();
      resolve();
    } else {
      this.current--;
    }
  }
}

// AsyncPool ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –æ–±—ä–µ–∫—Ç–æ–≤
```

**–†–∞–∑–ª–∏—á–∏—è:**
- **–°–µ–º–∞—Ñ–æ—Ä** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Å—á–µ—Ç—á–∏–∫, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –æ–±—ä–µ–∫—Ç—ã
- **AsyncPool** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤

### AsyncPool vs Worker Pool

```javascript
// Worker Pool ‚Äî –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
const { Worker } = require('worker_threads');

class WorkerPool {
  constructor(workerScript, poolSize) {
    this.workers = [];
    for (let i = 0; i < poolSize; i++) {
      this.workers.push(new Worker(workerScript));
    }
  }

  async exec(data) {
    const worker = await this.getAvailableWorker();
    return new Promise((resolve, reject) => {
      worker.once('message', resolve);
      worker.once('error', reject);
      worker.postMessage(data);
    });
  }
}
```

**–†–∞–∑–ª–∏—á–∏—è:**
- **Worker Pool** ‚Äî —Å–ø–µ—Ü–∏—Ñ–∏—á–µ–Ω –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- **AsyncPool** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ª—é–±—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏

### –ü—Ä–∏–º–µ—Ä: –ü—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ PostgreSQL

```javascript
const { Client } = require('pg');

const pgConnectionFactory = (index) => {
  const client = new Client({
    host: 'localhost',
    port: 5432,
    database: 'mydb',
    user: 'user',
    password: 'password'
  });

  // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  client.connect();

  return client;
};

const dbPool = new AsyncPool(pgConnectionFactory, {
  size: 20,
  timeout: 10000
});

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
async function getUser(id) {
  const client = await dbPool.getInstance();
  try {
    const result = await client.query('SELECT * FROM users WHERE id = $1', [id]);
    return result.rows[0];
  } finally {
    dbPool.release(client);
  }
}
```

### –ü—Ä–∏–º–µ—Ä: –ü—É–ª HTTP-–∞–≥–µ–Ω—Ç–æ–≤

```javascript
const https = require('https');

const httpsAgentFactory = () => {
  return new https.Agent({
    keepAlive: true,
    maxSockets: 1,  // –û–¥–∏–Ω —Å–æ–∫–µ—Ç –Ω–∞ –∞–≥–µ–Ω—Ç
    timeout: 5000
  });
};

const agentPool = new AsyncPool(httpsAgentFactory, {
  size: 50,  // 50 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  timeout: 3000
});

async function fetchData(url) {
  const agent = await agentPool.getInstance();
  try {
    return await new Promise((resolve, reject) => {
      https.get(url, { agent }, (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => resolve(data));
      }).on('error', reject);
    });
  } finally {
    agentPool.release(agent);
  }
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AsyncPool

### –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

```javascript
const assert = require('assert');

describe('AsyncPool', () => {
  it('should create instances via factory', async () => {
    let factoryCallCount = 0;
    const factory = () => ({ id: factoryCallCount++ });

    const pool = new AsyncPool(factory, 5);

    assert.strictEqual(pool.size, 5);
    assert.strictEqual(pool.available, 5);
    assert.strictEqual(factoryCallCount, 5);
  });

  it('should provide instances immediately when available', async () => {
    const factory = (i) => ({ id: i });
    const pool = new AsyncPool(factory, 3);

    const inst1 = await pool.getInstance();
    const inst2 = await pool.getInstance();

    assert.strictEqual(pool.available, 1);
    assert.ok(inst1.id !== inst2.id);
  });

  it('should queue requests when pool exhausted', async () => {
    const factory = (i) => ({ id: i });
    const pool = new AsyncPool(factory, 2);

    const inst1 = await pool.getInstance();
    const inst2 = await pool.getInstance();

    let inst3Resolved = false;
    const inst3Promise = pool.getInstance().then(inst => {
      inst3Resolved = true;
      return inst;
    });

    // inst3 –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å
    await new Promise(resolve => setImmediate(resolve));
    assert.strictEqual(inst3Resolved, false);

    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º inst1
    pool.release(inst1);

    const inst3 = await inst3Promise;
    assert.strictEqual(inst3Resolved, true);
    assert.strictEqual(inst3.id, inst1.id);  // –ü–æ–ª—É—á–∏–ª–∏ —Ç–æ—Ç –∂–µ –∏–Ω—Å—Ç–∞–Ω—Å
  });

  it('should reject on timeout', async () => {
    const factory = (i) => ({ id: i });
    const pool = new AsyncPool(factory, { size: 1, timeout: 100 });

    const inst1 = await pool.getInstance();

    // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å –ø–æ —Ç–∞–π–º–∞—É—Ç—É
    await assert.rejects(
      pool.getInstance(),
      /Pool timeout exceeded/
    );
  });

  it('should throw when releasing foreign instance', async () => {
    const factory = (i) => ({ id: i });
    const pool = new AsyncPool(factory, 2);

    const foreignInstance = { id: 999 };

    assert.throws(
      () => pool.release(foreignInstance),
      /not managed by this pool/
    );
  });

  it('should throw when releasing already free instance', async () => {
    const factory = (i) => ({ id: i });
    const pool = new AsyncPool(factory, 2);

    const inst = await pool.getInstance();
    pool.release(inst);

    assert.throws(
      () => pool.release(inst),
      /already free instance/
    );
  });
});
```

### –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç

```javascript
async function stressTest() {
  const factory = (i) => ({
    id: i,
    async work() {
      await new Promise(resolve => setTimeout(resolve, Math.random() * 100));
    }
  });

  const pool = new AsyncPool(factory, { size: 10, timeout: 5000 });
  const operations = [];

  // 1000 –æ–ø–µ—Ä–∞—Ü–∏–π
  for (let i = 0; i < 1000; i++) {
    operations.push((async () => {
      const inst = await pool.getInstance();
      try {
        await inst.work();
      } finally {
        pool.release(inst);
      }
    })());
  }

  const start = Date.now();
  await Promise.all(operations);
  const duration = Date.now() - start;

  console.log(`Completed 1000 operations in ${duration}ms`);
  console.log(`Average: ${(duration / 1000).toFixed(2)}ms per operation`);
}
```

---

## –†–µ–∑—é–º–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ AsyncPool

‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑, –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π Promise-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –∫–æ–ª–±–µ–∫–æ–≤

‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫** ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è

‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø—É–ª–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

üéØ **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

üéØ **HTTP-–∫–ª–∏–µ–Ω—Ç—ã** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API

üéØ **–§–∞–π–ª–æ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤

üéØ **–¢—è–∂–µ–ª—ã–µ –æ–±—ä–µ–∫—Ç—ã** ‚Äî –ø–∞—Ä—Å–µ—Ä—ã, –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã, –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã

üéØ **Worker threads** ‚Äî –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

### –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

‚ùå **–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã** ‚Äî –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—É–ª–∞ –ø–µ—Ä–µ–≤–µ—Å—è—Ç –≤—ã–≥–æ–¥—É

‚ùå **–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã** ‚Äî –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–æ–∂–¥—ã

‚ùå **–û–±—ä–µ–∫—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** ‚Äî –µ—Å–ª–∏ —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –∏–ª–∏ —Å–ª–æ–∂–µ–Ω

‚ùå **–ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** ‚Äî –ø—Ä–∏ —Ä–µ–¥–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –ø—É–ª –Ω–µ –¥–∞—Å—Ç –≤—ã–∏–≥—Ä—ã—à–∞

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥

–ü—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—É–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ **Metarhia**:
- [AsyncPool –≤ Metarhia](https://github.com/metarhia/metautil)

–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ª–µ–∫—Ü–∏–∏:
- –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è AsyncPool
- AsyncPool —Å —Ç–∞–π–º–∞—É—Ç–æ–º —á–µ—Ä–µ–∑ setTimeout
- AsyncPool —Å AbortSignal

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–≥–ª—É–±–ª–µ–Ω–∏—é

1. **–ò–∑—É—á–∏—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö:**
   - `pg-pool` –¥–ª—è PostgreSQL
   - `generic-pool` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É–ª–æ–≤
   - `tarn` ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å TypeScript

2. **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å –∫–æ–¥–æ–º:**
   - –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å –Ω—É–ª—è
   - –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è (LIFO, FIFO, LRU)

3. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:**
   - –°–æ–∑–¥–∞–π—Ç–µ –ø—É–ª –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
   - –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –°—Ä–∞–≤–Ω–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å/–±–µ–∑ –ø—É–ª–∞

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

AsyncPool ‚Äî —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –ü–∏—Å–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥
- –ò–∑–±–µ–≥–∞—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã

–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

**–£—Å–ø–µ—Ö–æ–≤ –≤ –∏–∑—É—á–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è!** üöÄ
