<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reference counting with using &amp; Disposable - Patterns</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-14213fa4.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-d959ff8c.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Patterns</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="подсчет-ссылок-на-ресурс-при-помощи-using-и-disposable-в-javascript"><a class="header" href="#подсчет-ссылок-на-ресурс-при-помощи-using-и-disposable-в-javascript">Подсчет ссылок на ресурс при помощи Using и Disposable в JavaScript</a></h1>
<h2 id="обзор"><a class="header" href="#обзор">Обзор</a></h2>
<p>Данная лекция посвящена реализации паттерна Reference Counter (счетчик ссылок) с использованием новых возможностей JavaScript — <code>using</code> и <code>disposable</code>. Эти механизмы появились недавно (Node.js v24, современные версии Chrome) и позволяют управлять жизненным циклом ресурсов более явно и безопасно, чем традиционные подходы.</p>
<p><strong>Основные темы:</strong></p>
<ul>
<li>Explicit Resource Management (явное управление ресурсами)</li>
<li>Реализация Reference Counter на базе <code>using</code> и <code>disposable</code></li>
<li>Автоматическое освобождение ресурсов при выходе из блока</li>
<li>Сравнение с подходом на базе Finalization Registry</li>
<li>Практические примеры с файловыми дескрипторами и логированием</li>
</ul>
<hr>
<h2 id="введение-в-explicit-resource-management"><a class="header" href="#введение-в-explicit-resource-management">Введение в Explicit Resource Management</a></h2>
<h3 id="что-такое-explicit-resource-management"><a class="header" href="#что-такое-explicit-resource-management">Что такое Explicit Resource Management?</a></h3>
<p><strong>Explicit Resource Management</strong> — это паттерн явного управления ресурсами, который позволяет гарантировать освобождение ресурсов (файлы, соединения, память) при выходе из области видимости.</p>
<h3 id="ключевые-концепции"><a class="header" href="#ключевые-концепции">Ключевые концепции</a></h3>
<p><strong><code>using</code> declaration</strong> — специальное объявление переменной, которое автоматически вызывает метод <code>Symbol.dispose</code> при выходе из блока.</p>
<p><strong><code>Symbol.dispose</code></strong> — специальный символ, определяющий метод очистки ресурса.</p>
<p><strong>Disposable объект</strong> — объект, имеющий метод <code>[Symbol.dispose]()</code>, который вызывается автоматически.</p>
<h4 id="базовый-пример-использования"><a class="header" href="#базовый-пример-использования">Базовый пример использования</a></h4>
<pre><code class="language-javascript">// Объект с методом dispose
const resource = {
  value: 'some data',
  [Symbol.dispose]() {
    console.log('Resource disposed');
    // Здесь происходит очистка ресурса
  }
};

// Использование using
{
  using myResource = resource;
  console.log(myResource.value); // 'some data'
  // При выходе из блока автоматически вызовется resource[Symbol.dispose]()
}
// Вывод: 'Resource disposed'
</code></pre>
<p><strong>Преимущества:</strong></p>
<ul>
<li>Автоматическое освобождение ресурсов</li>
<li>Защита от утечек памяти</li>
<li>Работает даже при выбросе исключений</li>
<li>Более короткий и понятный синтаксис по сравнению с <code>try...finally</code></li>
</ul>
<hr>
<h2 id="reference-counter-базовая-реализация"><a class="header" href="#reference-counter-базовая-реализация">Reference Counter: Базовая реализация</a></h2>
<h3 id="концепция-reference-counter"><a class="header" href="#концепция-reference-counter">Концепция Reference Counter</a></h3>
<p><strong>Reference Counter (счетчик ссылок)</strong> — паттерн, который отслеживает количество активных ссылок на ресурс и автоматически освобождает ресурс, когда счетчик достигает нуля.</p>
<h3 id="структура-reference-counter"><a class="header" href="#структура-reference-counter">Структура Reference Counter</a></h3>
<pre><code class="language-javascript">class ReferenceCounter {
  #resource = null;      // Сам ресурс (например, консоль)
  #context = null;       // Контекст с данными для финализации
  #counter = 0;          // Счетчик активных ссылок
  #create = null;        // Функция создания ресурса
  #dispose = null;       // Функция освобождения ресурса

  constructor(create, dispose) {
    this.#create = create;
    this.#dispose = dispose;
  }

  // Методы будут рассмотрены ниже
}
</code></pre>
<p><strong>Поля класса:</strong></p>
<ul>
<li><code>#resource</code> — хранит созданный экземпляр ресурса</li>
<li><code>#context</code> — контекст с дополнительными данными (например, файловый дескриптор)</li>
<li><code>#counter</code> — текущее количество активных ссылок</li>
<li><code>#create</code> — функция-фабрика для создания ресурса</li>
<li><code>#dispose</code> — функция для освобождения ресурса</li>
</ul>
<hr>
<h2 id="пример-7-простой-reference-counter-для-логера"><a class="header" href="#пример-7-простой-reference-counter-для-логера">Пример 7: Простой Reference Counter для логера</a></h2>
<h3 id="постановка-задачи"><a class="header" href="#постановка-задачи">Постановка задачи</a></h3>
<p>Создать логер, который:</p>
<ol>
<li>Записывает данные в файл</li>
<li>Автоматически открывает файл при первом использовании</li>
<li>Автоматически закрывает файл, когда все блоки завершены</li>
<li>Использует Reference Counter для отслеживания активных использований</li>
</ol>
<h3 id="реализация-создания-логера"><a class="header" href="#реализация-создания-логера">Реализация создания логера</a></h3>
<pre><code class="language-javascript">import { open } from 'node:fs';
import { Console } from 'node:console';

// Функция создания экземпляра логера
const createLogger = () =&gt; {
  // Открываем файл для записи
  const fd = open('output.log', 'w');

  // Создаем поток для записи
  const stream = fs.createWriteStream(null, { fd });

  // Создаем консоль, которая пишет в поток
  const console = new Console(stream);

  // Возвращаем ресурс и контекст
  return {
    resource: console,    // Сама консоль для использования
    context: { fd }       // Файловый дескриптор для закрытия
  };
};

// Функция финализации (освобождения) логера
const disposeLogger = (context) =&gt; {
  // Закрываем файловый дескриптор из контекста
  context.fd.close();
};

// Создаем Reference Counter для логера
const logger = new ReferenceCounter(createLogger, disposeLogger);
</code></pre>
<p><strong>Важные моменты:</strong></p>
<ul>
<li>Функция <code>createLogger</code> возвращает объект с двумя полями: <code>resource</code> и <code>context</code></li>
<li><code>resource</code> — это то, что будет использоваться в коде (консоль)</li>
<li><code>context</code> — это данные для финализации (файловый дескриптор)</li>
<li>Reference Counter универсален — он не привязан к конкретному типу ресурса</li>
</ul>
<h3 id="метод-use--создание-disposable"><a class="header" href="#метод-use--создание-disposable">Метод use() — создание Disposable</a></h3>
<pre><code class="language-javascript">class ReferenceCounter {
  // ... предыдущий код ...

  use() {
    // Увеличиваем счетчик ссылок
    this.#counter++;

    // Берем ресурс (консоль)
    const resource = this.#resource;

    // Создаем новый объект, наследующий от ресурса
    const disposable = Object.create(resource);

    // Добавляем метод dispose
    disposable[Symbol.dispose] = () =&gt; {
      // Уменьшаем счетчик при выходе из блока
      this.#counter--;

      // Если счетчик достиг нуля
      if (this.#counter === 0) {
        // Вызываем функцию освобождения ресурса
        this.#dispose(this.#context);

        // Очищаем ссылки
        this.#resource = null;
        this.#context = null;
      }
    };

    // Возвращаем disposable объект
    return disposable;
  }
}
</code></pre>
<p><strong>Механизм работы <code>use()</code>:</strong></p>
<ol>
<li><strong>Инкремент счетчика:</strong> при каждом вызове <code>use()</code> увеличивается <code>#counter</code></li>
<li><strong>Создание disposable:</strong> создается новый объект с прототипной ссылкой на ресурс</li>
<li><strong>Добавление <code>Symbol.dispose</code>:</strong> в объект добавляется метод для автоматической очистки</li>
<li><strong>Декремент при dispose:</strong> когда блок <code>using</code> завершается, счетчик уменьшается</li>
<li><strong>Финализация при нуле:</strong> когда счетчик достигает 0, вызывается функция освобождения</li>
</ol>
<h3 id="использование-в-коде"><a class="header" href="#использование-в-коде">Использование в коде</a></h3>
<pre><code class="language-javascript">async function main() {
  // Блок 0: первое использование логера
  {
    using console0 = logger.use();
    console0.log('log 0');

    // Блок 1: вложенное использование
    {
      using console1 = logger.use();
      console1.log('log 1');

      // Блок 2: еще более вложенное использование
      {
        using console2 = logger.use();
        console2.log('log 2');

        // Сохраняем ссылку для использования вне блока
        rf3 = console2;
      } // dispose для console2 - счетчик: 3 -&gt; 2
    } // dispose для console1 - счетчик: 2 -&gt; 1
  } // dispose для console0 - счетчик: 1 -&gt; 0, вызов disposeLogger

  // Блок 3: попытка использовать утекшую ссылку
  {
    using rf4 = rf3; // Это та же ссылка, но ресурс уже освобожден
    rf4.log('log 3'); // Запись НЕ произойдет - файл закрыт!
  }
}

const rf4 = await main();
console.log('After main');
rf4.log('log 4'); // Тоже НЕ запишется - ресурс освобожден
</code></pre>
<p><strong>Пошаговая трассировка:</strong></p>
<pre><code>1. Открытие файла:
   - createLogger вызван
   - fd открыт, stream создан, console создан
   - counter = 0

2. Вход в блок 0:
   - use() вызван
   - counter = 1
   - console0.log('log 0') → запись в файл ✓

3. Вход в блок 1:
   - use() вызван
   - counter = 2
   - console1.log('log 1') → запись в файл ✓

4. Вход в блок 2:
   - use() вызван
   - counter = 3
   - console2.log('log 2') → запись в файл ✓
   - rf3 = console2 (сохранение ссылки)

5. Выход из блока 2:
   - Symbol.dispose вызван для console2
   - counter = 2

6. Выход из блока 1:
   - Symbol.dispose вызван для console1
   - counter = 1

7. Выход из блока 0:
   - Symbol.dispose вызван для console0
   - counter = 0
   - disposeLogger вызван
   - fd.close() - ФАЙЛ ЗАКРЫТ
   - resource = null, context = null

8. Использование rf3/rf4:
   - Ссылка существует, но ресурс уже освобожден
   - Попытки записи не дадут результата
</code></pre>
<h3 id="результат-выполнения"><a class="header" href="#результат-выполнения">Результат выполнения</a></h3>
<p><strong>Вывод в консоль:</strong></p>
<pre><code>open
use (counter: 1)
dispose (counter: 0)
use (counter: 1)
use (counter: 2)
dispose (counter: 1)
dispose (counter: 0)
close
After main
</code></pre>
<p><strong>Содержимое output.log:</strong></p>
<pre><code>log 0
log 1
log 2
</code></pre>
<p><strong>Что НЕ записалось:</strong></p>
<ul>
<li><code>log 3</code> — ресурс уже освобожден</li>
<li><code>log 4</code> — ресурс уже освобожден</li>
</ul>
<hr>
<h2 id="пример-8-reference-counter-с-коллекцией-файлов"><a class="header" href="#пример-8-reference-counter-с-коллекцией-файлов">Пример 8: Reference Counter с коллекцией файлов</a></h2>
<h3 id="постановка-задачи-1"><a class="header" href="#постановка-задачи-1">Постановка задачи</a></h3>
<p>Создать логер, который может работать с <strong>несколькими файлами одновременно</strong>, где:</p>
<ul>
<li>Для каждого файла ведется свой счетчик ссылок</li>
<li>Файл открывается только один раз при первом обращении</li>
<li>Файл закрывается, когда его счетчик достигает нуля</li>
<li>Разные блоки могут писать в разные файлы</li>
</ul>
<h3 id="структура-данных-для-коллекции-файлов"><a class="header" href="#структура-данных-для-коллекции-файлов">Структура данных для коллекции файлов</a></h3>
<pre><code class="language-javascript">class MultiFileLogger {
  // Коллекция открытых файлов
  // Ключ: имя файла (строка)
  // Значение: объект с полями { counter, fd, console }
  #files = new Map();

  constructor() {
    // Инициализация пустой коллекции
  }
}
</code></pre>
<p><strong>Структура записи в коллекции:</strong></p>
<pre><code class="language-javascript">{
  'output.log': {
    counter: 2,           // Количество активных использований
    fd: &lt;FileDescriptor&gt;, // Файловый дескриптор
    console: &lt;Console&gt;    // Экземпляр консоли для записи
  },
  'output3.log': {
    counter: 1,
    fd: &lt;FileDescriptor&gt;,
    console: &lt;Console&gt;
  }
}
</code></pre>
<h3 id="метод-open--открытие-файла"><a class="header" href="#метод-open--открытие-файла">Метод open() — открытие файла</a></h3>
<pre><code class="language-javascript">class MultiFileLogger {
  #files = new Map();

  open(fileName) {
    // Открываем файл для записи
    const fd = fs.openSync(fileName, 'w');

    // Создаем поток записи
    const stream = fs.createWriteStream(null, { fd });

    // Создаем консоль для этого потока
    const console = new Console(stream);

    // Возвращаем структуру для сохранения в коллекцию
    return {
      counter: 0,  // Начальное значение счетчика
      fd,          // Файловый дескриптор
      console      // Консоль для записи
    };
  }
}
</code></pre>
<h3 id="метод-use--получение-disposable-для-файла"><a class="header" href="#метод-use--получение-disposable-для-файла">Метод use() — получение disposable для файла</a></h3>
<pre><code class="language-javascript">class MultiFileLogger {
  #files = new Map();

  use(fileName) {
    // Пытаемся найти файл в коллекции
    let instance = this.#files.get(fileName);

    // Если файл еще не открыт
    if (!instance) {
      // Открываем файл и получаем структуру
      instance = this.open(fileName);

      // Сохраняем в коллекцию
      this.#files.set(fileName, instance);
    }

    // Увеличиваем счетчик для этого файла
    instance.counter++;

    // Создаем disposable объект на базе консоли
    const disposable = Object.create(instance.console);

    // Добавляем метод dispose
    disposable[Symbol.dispose] = () =&gt; {
      // Уменьшаем счетчик
      instance.counter--;

      // Если счетчик достиг нуля
      if (instance.counter === 0) {
        // Закрываем файл
        instance.fd.close();

        // Удаляем из коллекции
        this.#files.delete(fileName);
      }
    };

    // Возвращаем disposable
    return disposable;
  }
}

// Создаем экземпляр логера
const logger = new MultiFileLogger();
</code></pre>
<p><strong>Логика работы <code>use(fileName)</code>:</strong></p>
<ol>
<li><strong>Поиск в коллекции:</strong> проверяем, открыт ли уже этот файл</li>
<li><strong>Ленивое открытие:</strong> если файла нет, открываем его и добавляем в коллекцию</li>
<li><strong>Инкремент счетчика:</strong> увеличиваем счетчик для данного файла</li>
<li><strong>Создание disposable:</strong> создаем объект с методом <code>Symbol.dispose</code></li>
<li><strong>Закрытие при нуле:</strong> когда счетчик файла становится 0, файл закрывается и удаляется из коллекции</li>
</ol>
<h3 id="использование-с-несколькими-файлами"><a class="header" href="#использование-с-несколькими-файлами">Использование с несколькими файлами</a></h3>
<pre><code class="language-javascript">async function main() {
  // Блок 0: работа с output.log
  {
    using c0 = logger.use('output.log');
    c0.log('log 0');  // Файл открывается, counter = 1

    // Блок 1: вложенное использование того же файла
    {
      using c1 = logger.use('output.log');
      c1.log('log 1');  // Файл уже открыт, counter = 2

      // Блок 2: еще более вложенное использование
      {
        using c2 = logger.use('output.log');
        c2.log('log 2');  // counter = 3

        // Блок 3: работа с ДРУГИМ файлом
        {
          using c3 = logger.use('output3.log');
          c3.log('log 3');  // Новый файл открывается, его counter = 1
        } // dispose c3: output3.log counter = 0, файл закрывается

        // Сохраняем ссылку для демонстрации утечки
        rf = c2;
      } // dispose c2: output.log counter = 2
    } // dispose c1: output.log counter = 1
  } // dispose c0: output.log counter = 0, файл закрывается

  // Возвращаем утекшую ссылку
  return rf;
}

// Блок 4: использование утекшей ссылки
{
  const f1 = await main();
  using c4 = f1;
  c4.log('log 4');  // НЕ запишется - файл уже закрыт!
}

// Блок 5: попытка использовать после завершения блока 4
{
  using c5 = f1;
  c5.log('log 5');  // НЕ запишется - файл закрыт!
}
</code></pre>
<h3 id="пошаговая-трассировка-выполнения"><a class="header" href="#пошаговая-трассировка-выполнения">Пошаговая трассировка выполнения</a></h3>
<pre><code>=== Начало выполнения ===

1. Вход в блок 0:
   logger.use('output.log')
   - Файл не найден в коллекции
   - open('output.log') вызван
   - files.set('output.log', { counter: 0, fd, console })
   - counter для output.log = 1
   - c0.log('log 0') → запись в output.log ✓

2. Вход в блок 1:
   logger.use('output.log')
   - Файл найден в коллекции
   - counter для output.log = 2
   - c1.log('log 1') → запись в output.log ✓

3. Вход в блок 2:
   logger.use('output.log')
   - Файл найден в коллекции
   - counter для output.log = 3
   - c2.log('log 2') → запись в output.log ✓
   - rf = c2 (сохранение ссылки)

4. Вход в блок 3:
   logger.use('output3.log')
   - Файл не найден в коллекции
   - open('output3.log') вызван
   - files.set('output3.log', { counter: 0, fd, console })
   - counter для output3.log = 1
   - c3.log('log 3') → запись в output3.log ✓

5. Выход из блока 3:
   - Symbol.dispose для c3
   - counter для output3.log = 0
   - fd.close() для output3.log
   - files.delete('output3.log')
   - output3.log ЗАКРЫТ ✓

6. Выход из блока 2:
   - Symbol.dispose для c2
   - counter для output.log = 2

7. Выход из блока 1:
   - Symbol.dispose для c1
   - counter для output.log = 1

8. Выход из блока 0:
   - Symbol.dispose для c0
   - counter для output.log = 0
   - fd.close() для output.log
   - files.delete('output.log')
   - output.log ЗАКРЫТ ✓

9. Использование в блоке 4:
   - f1 = rf (утекшая ссылка)
   - c4.log('log 4') → НЕ запишется (файл закрыт) ✗

10. Использование в блоке 5:
    - c5.log('log 5') → НЕ запишется (файл закрыт) ✗
</code></pre>
<h3 id="результаты-выполнения"><a class="header" href="#результаты-выполнения">Результаты выполнения</a></h3>
<p><strong>Вывод в консоль:</strong></p>
<pre><code>open output.log
use output.log (counter: 1)
use output.log (counter: 2)
use output.log (counter: 3)
open output3.log
use output3.log (counter: 1)
dispose output3.log (counter: 0)
close output3.log
dispose output.log (counter: 2)
dispose output.log (counter: 1)
dispose output.log (counter: 0)
close output.log
After main
</code></pre>
<p><strong>Содержимое output.log:</strong></p>
<pre><code>log 0
log 1
log 2
</code></pre>
<p><strong>Содержимое output3.log:</strong></p>
<pre><code>log 3
</code></pre>
<p><strong>Что НЕ записалось:</strong></p>
<ul>
<li><code>log 4</code> — output.log уже закрыт</li>
<li><code>log 5</code> — output.log уже закрыт</li>
</ul>
<hr>
<h2 id="сравнение-подходов-finalization-registry-vs-usingdisposable"><a class="header" href="#сравнение-подходов-finalization-registry-vs-usingdisposable">Сравнение подходов: Finalization Registry vs Using/Disposable</a></h2>
<h3 id="finalization-registry"><a class="header" href="#finalization-registry">Finalization Registry</a></h3>
<p><strong>Принцип работы:</strong></p>
<ul>
<li>Регистрирует callback для вызова при сборке мусора</li>
<li>Зависит от работы Garbage Collector</li>
<li>Недетерминированное время выполнения</li>
</ul>
<h4 id="пример-с-finalization-registry"><a class="header" href="#пример-с-finalization-registry">Пример с Finalization Registry</a></h4>
<pre><code class="language-javascript">// Создаем registry для отслеживания освобождения ресурсов
const registry = new FinalizationRegistry((context) =&gt; {
  // Этот callback вызовется когда-то в будущем
  console.log('Finalization:', context.name);
  context.fd.close();
});

class LoggerWithRegistry {
  constructor(fileName) {
    const fd = fs.openSync(fileName, 'w');
    const stream = fs.createWriteStream(null, { fd });
    this.console = new Console(stream);

    // Регистрируем для финализации
    registry.register(this, { name: fileName, fd });
  }
}

// Использование
{
  const logger = new LoggerWithRegistry('output.log');
  logger.console.log('Hello');
  // logger выходит из области видимости
}

// Файл может закрыться через несколько секунд (или минут, или никогда)
// В зависимости от того, когда запустится GC
</code></pre>
<p><strong>Проблемы Finalization Registry:</strong></p>
<ol>
<li>
<p><strong>Недетерминированность:</strong></p>
<pre><code class="language-javascript">{
  const logger = new LoggerWithRegistry('output.log');
  logger.console.log('Message');
}

// Файл может остаться открытым неопределенно долго
fs.readFileSync('output.log'); // Может быть не готов!
</code></pre>
</li>
<li>
<p><strong>Может не вызваться вообще:</strong></p>
<pre><code class="language-javascript">{
  const logger = new LoggerWithRegistry('output.log');
  logger.console.log('Message');
}

// Если программа завершится до GC
process.exit(0); // Файл может остаться незакрытым!
</code></pre>
</li>
<li>
<p><strong>Невозможно контролировать момент очистки:</strong></p>
<pre><code class="language-javascript">for (let i = 0; i &lt; 1000; i++) {
  const logger = new LoggerWithRegistry(`file${i}.log`);
  logger.console.log(`Message ${i}`);
}

// Все 1000 файлов могут оставаться открытыми!
// Достижение лимита файловых дескрипторов
</code></pre>
</li>
</ol>
<h3 id="usingdisposable"><a class="header" href="#usingdisposable">Using/Disposable</a></h3>
<p><strong>Принцип работы:</strong></p>
<ul>
<li>Детерминированное освобождение ресурсов</li>
<li>Вызывается сразу при выходе из блока</li>
<li>Работает даже при исключениях</li>
</ul>
<h4 id="пример-с-usingdisposable"><a class="header" href="#пример-с-usingdisposable">Пример с Using/Disposable</a></h4>
<pre><code class="language-javascript">class LoggerWithDisposable {
  #fd = null;

  constructor(fileName) {
    this.#fd = fs.openSync(fileName, 'w');
    const stream = fs.createWriteStream(null, { fd: this.#fd });
    this.console = new Console(stream);
  }

  [Symbol.dispose]() {
    // Вызовется ГАРАНТИРОВАННО при выходе из блока
    console.log('Disposing logger');
    this.#fd.close();
  }
}

// Использование
{
  using logger = new LoggerWithDisposable('output.log');
  logger.console.log('Hello');
} // Файл закрывается СРАЗУ И ГАРАНТИРОВАННО
</code></pre>
<p><strong>Преимущества Using/Disposable:</strong></p>
<ol>
<li>
<p><strong>Детерминированность:</strong></p>
<pre><code class="language-javascript">{
  using logger = new LoggerWithDisposable('output.log');
  logger.console.log('Message');
} // Файл закрыт ПРЯМО ЗДЕСЬ

// Файл точно закрыт
fs.readFileSync('output.log'); // Всегда готов для чтения
</code></pre>
</li>
<li>
<p><strong>Работает с исключениями:</strong></p>
<pre><code class="language-javascript">try {
  using logger = new LoggerWithDisposable('output.log');
  logger.console.log('Message');
  throw new Error('Something went wrong');
} catch (err) {
  // Symbol.dispose ВСЁ РАВНО вызовется
  // Файл точно закрыт
}
</code></pre>
</li>
<li>
<p><strong>Контролируемое управление ресурсами:</strong></p>
<pre><code class="language-javascript">for (let i = 0; i &lt; 1000; i++) {
  using logger = new LoggerWithDisposable(`file${i}.log`);
  logger.console.log(`Message ${i}`);
  // Файл закрывается на каждой итерации
} // Максимум 1 открытый файл одновременно
</code></pre>
</li>
</ol>
<h3 id="сравнительная-таблица"><a class="header" href="#сравнительная-таблица">Сравнительная таблица</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Характеристика</th><th>Finalization Registry</th><th>Using/Disposable</th></tr>
</thead>
<tbody>
<tr><td><strong>Время вызова</strong></td><td>Недетерминированное (зависит от GC)</td><td>Детерминированное (сразу при выходе из блока)</td></tr>
<tr><td><strong>Гарантия вызова</strong></td><td>Может не вызваться</td><td>Гарантированно вызывается</td></tr>
<tr><td><strong>Работа с исключениями</strong></td><td>Может не сработать при ранних выходах</td><td>Работает всегда (как <code>finally</code>)</td></tr>
<tr><td><strong>Предсказуемость</strong></td><td>Низкая</td><td>Высокая</td></tr>
<tr><td><strong>Синтаксис</strong></td><td>Многословный</td><td>Краткий (<code>using</code>)</td></tr>
<tr><td><strong>Использование в продакшене</strong></td><td>Только для некритичных случаев</td><td>Рекомендуется для управления ресурсами</td></tr>
<tr><td><strong>Задержка освобождения</strong></td><td>От секунд до бесконечности</td><td>Мгновенно</td></tr>
<tr><td><strong>Контроль памяти</strong></td><td>Слабый</td><td>Полный</td></tr>
</tbody>
</table>
</div>
<h3 id="когда-использовать-каждый-подход"><a class="header" href="#когда-использовать-каждый-подход">Когда использовать каждый подход</a></h3>
<p><strong>Finalization Registry:</strong></p>
<ul>
<li>Кеширование, где важна производительность</li>
<li>Очистка некритичных данных</li>
<li>Дополнительная подстраховка (но не основной механизм)</li>
</ul>
<pre><code class="language-javascript">// Пример: кеш с автоочисткой
const cache = new Map();
const registry = new FinalizationRegistry((key) =&gt; {
  cache.delete(key);
});

function cacheValue(key, value) {
  cache.set(key, value);
  registry.register(value, key);
}
</code></pre>
<p><strong>Using/Disposable:</strong></p>
<ul>
<li>Файловые дескрипторы</li>
<li>Сетевые соединения</li>
<li>Блокировки и мьютексы</li>
<li>Транзакции базы данных</li>
<li>Любые критичные ресурсы, требующие своевременного освобождения</li>
</ul>
<pre><code class="language-javascript">// Пример: транзакция базы данных
async function updateUser(userId, data) {
  using transaction = await db.beginTransaction();
  try {
    await transaction.update('users', { id: userId }, data);
    await transaction.commit();
  } catch (err) {
    // transaction.dispose() вызовется автоматически
    // и сделает rollback
  }
}
</code></pre>
<hr>
<h2 id="преимущества-и-ограничения-reference-counter"><a class="header" href="#преимущества-и-ограничения-reference-counter">Преимущества и ограничения Reference Counter</a></h2>
<h3 id="преимущества"><a class="header" href="#преимущества">Преимущества</a></h3>
<h4 id="1-автоматическое-управление-жизненным-циклом"><a class="header" href="#1-автоматическое-управление-жизненным-циклом">1. Автоматическое управление жизненным циклом</a></h4>
<pre><code class="language-javascript">// БЕЗ Reference Counter - ручное управление
function withoutRefCounter() {
  const fd = fs.openSync('file.log', 'w');
  const stream = fs.createWriteStream(null, { fd });
  const logger = new Console(stream);

  try {
    logger.log('Message 1');

    try {
      logger.log('Message 2');
      // ... вложенная логика
    } finally {
      // Нужно отслеживать вручную
    }

    logger.log('Message 3');
  } finally {
    // Закрываем только здесь
    fd.close();
  }
}

// С Reference Counter - автоматически
function withRefCounter() {
  {
    using logger1 = logger.use('file.log');
    logger1.log('Message 1');

    {
      using logger2 = logger.use('file.log');
      logger2.log('Message 2');
    } // Счетчик уменьшается автоматически

    logger1.log('Message 3');
  } // Файл закрывается автоматически
}
</code></pre>
<h4 id="2-безопасность-при-исключениях"><a class="header" href="#2-безопасность-при-исключениях">2. Безопасность при исключениях</a></h4>
<pre><code class="language-javascript">// Даже при ошибках ресурсы освобождаются
async function processLogs() {
  {
    using logger = logger.use('output.log');
    logger.log('Start processing');

    // Может выбросить ошибку
    await riskyOperation();

    logger.log('End processing');
  } // dispose вызовется ДАЖЕ если riskyOperation бросит ошибку
}
</code></pre>
<h4 id="3-защита-от-утечек-ресурсов"><a class="header" href="#3-защита-от-утечек-ресурсов">3. Защита от утечек ресурсов</a></h4>
<pre><code class="language-javascript">// Невозможно забыть закрыть ресурс
function safeResourceUsage() {
  {
    using logger = logger.use('file.log');
    logger.log('Message');

    // Даже если забыли вручную закрыть - не проблема
    // return; // Ранний выход - dispose всё равно вызовется
  }
}
</code></pre>
<h3 id="ограничения-и-проблемы"><a class="header" href="#ограничения-и-проблемы">Ограничения и проблемы</a></h3>
<h4 id="1-утечшие-ссылки-не-работают"><a class="header" href="#1-утечшие-ссылки-не-работают">1. Утечшие ссылки не работают</a></h4>
<pre><code class="language-javascript">let leakedReference;

{
  using logger = logger.use('file.log');
  logger.log('Message');
  leakedReference = logger; // Сохраняем ссылку
} // Файл закрывается, счетчик = 0

// Ссылка существует, но бесполезна
leakedReference.log('This will not work'); // Файл уже закрыт!
</code></pre>
<p><strong>Решение:</strong> не сохранять ссылки на disposable объекты вне блока <code>using</code>.</p>
<h4 id="2-не-рекомендуется-для-продакшена-пока"><a class="header" href="#2-не-рекомендуется-для-продакшена-пока">2. Не рекомендуется для продакшена (пока)</a></h4>
<pre><code class="language-javascript">// Это прототип, не используйте в продакшене
// Нужно больше тестирования и доработки
const logger = new ReferenceCounter(/* ... */);

// TODO:
// - Обработка race conditions
// - Поддержка async dispose
// - Более надежная обработка ошибок
// - Тестирование edge cases
</code></pre>
<h4 id="3-необходима-поддержка-браузеромnodejs"><a class="header" href="#3-необходима-поддержка-браузеромnodejs">3. Необходима поддержка браузером/Node.js</a></h4>
<pre><code class="language-javascript">// Проверка поддержки
if (typeof Symbol.dispose === 'undefined') {
  console.error('Using/Disposable not supported!');
  // Нужен fallback или polyfill
}
</code></pre>
<hr>
<h2 id="практические-рекомендации"><a class="header" href="#практические-рекомендации">Практические рекомендации</a></h2>
<h3 id="1-структура-проекта-с-reference-counter"><a class="header" href="#1-структура-проекта-с-reference-counter">1. Структура проекта с Reference Counter</a></h3>
<pre><code class="language-javascript">// logger.js - модуль логирования
import { ReferenceCounter } from './reference-counter.js';

export const logger = new ReferenceCounter(
  // Создание ресурса
  () =&gt; {
    const fd = fs.openSync('app.log', 'a');
    const stream = fs.createWriteStream(null, { fd });
    const console = new Console(stream);
    return { resource: console, context: { fd } };
  },
  // Освобождение ресурса
  (context) =&gt; {
    context.fd.close();
  }
);

// app.js - использование
import { logger } from './logger.js';

export async function processRequest(request) {
  using log = logger.use();
  log.log('Request started:', request.id);

  try {
    await handleRequest(request);
    log.log('Request completed:', request.id);
  } catch (err) {
    log.error('Request failed:', err);
    throw err;
  }
  // dispose вызовется автоматически
}
</code></pre>
<h3 id="2-множественные-ресурсы"><a class="header" href="#2-множественные-ресурсы">2. Множественные ресурсы</a></h3>
<pre><code class="language-javascript">// Управление несколькими ресурсами одновременно
async function complexOperation() {
  using dbConnection = connectionPool.use();
  using fileLogger = logger.use('operation.log');
  using lockHandle = lockManager.use('operation-lock');

  // Все три ресурса будут автоматически освобождены
  await performOperation(dbConnection, fileLogger);

} // dispose вызовется для всех трех ресурсов
</code></pre>
<h3 id="3-правильная-обработка-ошибок"><a class="header" href="#3-правильная-обработка-ошибок">3. Правильная обработка ошибок</a></h3>
<pre><code class="language-javascript">class ReferenceCounter {
  use() {
    this.#counter++;
    const resource = this.#resource;
    const disposable = Object.create(resource);

    disposable[Symbol.dispose] = () =&gt; {
      this.#counter--;

      if (this.#counter === 0) {
        try {
          // Обрабатываем ошибки при dispose
          this.#dispose(this.#context);
        } catch (err) {
          // Логируем, но не пробрасываем
          console.error('Error during dispose:', err);
        } finally {
          // Всегда очищаем ссылки
          this.#resource = null;
          this.#context = null;
        }
      }
    };

    return disposable;
  }
}
</code></pre>
<h3 id="4-паттерн-для-ленивой-инициализации"><a class="header" href="#4-паттерн-для-ленивой-инициализации">4. Паттерн для ленивой инициализации</a></h3>
<pre><code class="language-javascript">class ReferenceCounter {
  #initialized = false;

  use() {
    // Инициализация при первом использовании
    if (!this.#initialized) {
      const { resource, context } = this.#create();
      this.#resource = resource;
      this.#context = context;
      this.#initialized = true;
    }

    this.#counter++;
    // ... остальной код
  }
}
</code></pre>
<hr>
<h2 id="диаграмма-жизненного-цикла-reference-counter"><a class="header" href="#диаграмма-жизненного-цикла-reference-counter">Диаграмма жизненного цикла Reference Counter</a></h2>
<pre><code>Состояние счетчика для output.log:

Блок 0 начало:  counter = 1  [FILE OPENED]
│
├── Блок 1 начало:  counter = 2
│   │
│   ├── Блок 2 начало:  counter = 3
│   │   │
│   │   └── Блок 2 конец:  counter = 2  [dispose вызван]
│   │
│   └── Блок 1 конец:  counter = 1  [dispose вызван]
│
└── Блок 0 конец:  counter = 0  [FILE CLOSED, dispose вызван]


Состояние счетчика для output3.log:

Блок 3 начало:  counter = 1  [FILE OPENED]
│
└── Блок 3 конец:  counter = 0  [FILE CLOSED, dispose вызван]
</code></pre>
<hr>
<h2 id="полный-код-реализации-reference-counter"><a class="header" href="#полный-код-реализации-reference-counter">Полный код реализации Reference Counter</a></h2>
<h3 id="reference-counterjs"><a class="header" href="#reference-counterjs">reference-counter.js</a></h3>
<pre><code class="language-javascript">/**
 * Reference Counter для управления жизненным циклом ресурсов
 * на основе механизма using/disposable
 */
export class ReferenceCounter {
  // Приватные поля
  #resource = null;   // Сам ресурс (объект для использования)
  #context = null;    // Контекст с данными для финализации
  #counter = 0;       // Счетчик активных ссылок
  #create = null;     // Функция создания ресурса
  #dispose = null;    // Функция освобождения ресурса

  /**
   * @param {Function} create - Функция создания ресурса
   *   Должна возвращать { resource, context }
   * @param {Function} dispose - Функция освобождения ресурса
   *   Принимает context в качестве параметра
   */
  constructor(create, dispose) {
    this.#create = create;
    this.#dispose = dispose;
  }

  /**
   * Создает disposable объект для использования с using
   * @returns {Object} Disposable объект с методом Symbol.dispose
   */
  use() {
    // Ленивая инициализация при первом использовании
    if (this.#resource === null) {
      const { resource, context } = this.#create();
      this.#resource = resource;
      this.#context = context;
    }

    // Увеличиваем счетчик ссылок
    this.#counter++;
    console.log(`use (counter: ${this.#counter})`);

    // Создаем новый объект, наследующий от ресурса
    const disposable = Object.create(this.#resource);

    // Добавляем метод dispose
    disposable[Symbol.dispose] = () =&gt; {
      // Уменьшаем счетчик
      this.#counter--;
      console.log(`dispose (counter: ${this.#counter})`);

      // Если счетчик достиг нуля - освобождаем ресурс
      if (this.#counter === 0) {
        try {
          this.#dispose(this.#context);
          console.log('close');
        } catch (err) {
          console.error('Error during dispose:', err);
        } finally {
          this.#resource = null;
          this.#context = null;
        }
      }
    };

    return disposable;
  }
}
</code></pre>
<h3 id="multi-file-loggerjs"><a class="header" href="#multi-file-loggerjs">multi-file-logger.js</a></h3>
<pre><code class="language-javascript">import fs from 'node:fs';
import { Console } from 'node:console';

/**
 * Логер с поддержкой нескольких файлов
 * и reference counting для каждого файла
 */
export class MultiFileLogger {
  // Коллекция открытых файлов
  // Map&lt;fileName, { counter, fd, console }&gt;
  #files = new Map();

  /**
   * Открывает файл и создает консоль для записи
   * @param {string} fileName - Имя файла
   * @returns {Object} Структура { counter, fd, console }
   */
  open(fileName) {
    console.log(`open ${fileName}`);

    // Открываем файл для записи
    const fd = fs.openSync(fileName, 'w');

    // Создаем поток записи
    const stream = fs.createWriteStream(null, { fd });

    // Создаем консоль для этого потока
    const console = new Console(stream);

    // Возвращаем структуру
    return {
      counter: 0,
      fd,
      console
    };
  }

  /**
   * Получает disposable для записи в файл
   * @param {string} fileName - Имя файла
   * @returns {Object} Disposable объект консоли
   */
  use(fileName) {
    // Ищем файл в коллекции
    let instance = this.#files.get(fileName);

    // Если файл не открыт - открываем
    if (!instance) {
      instance = this.open(fileName);
      this.#files.set(fileName, instance);
    }

    // Увеличиваем счетчик
    instance.counter++;
    console.log(`use ${fileName} (counter: ${instance.counter})`);

    // Создаем disposable
    const disposable = Object.create(instance.console);

    // Добавляем метод dispose
    disposable[Symbol.dispose] = () =&gt; {
      instance.counter--;
      console.log(`dispose ${fileName} (counter: ${instance.counter})`);

      // Если счетчик достиг нуля - закрываем файл
      if (instance.counter === 0) {
        instance.fd.close();
        this.#files.delete(fileName);
        console.log(`close ${fileName}`);
      }
    };

    return disposable;
  }
}
</code></pre>
<h3 id="example-7js"><a class="header" href="#example-7js">example-7.js</a></h3>
<pre><code class="language-javascript">import fs from 'node:fs';
import { Console } from 'node:console';
import { ReferenceCounter } from './reference-counter.js';

// Создание логера
const logger = new ReferenceCounter(
  // Функция создания
  () =&gt; {
    console.log('open');
    const fd = fs.openSync('output.log', 'w');
    const stream = fs.createWriteStream(null, { fd });
    const console = new Console(stream);
    return { resource: console, context: { fd } };
  },
  // Функция освобождения
  (context) =&gt; {
    context.fd.close();
  }
);

// Использование
async function main() {
  let rf3;

  // Блок 0
  {
    using console0 = logger.use();
    console0.log('log 0');

    // Блок 1
    {
      using console1 = logger.use();
      console1.log('log 1');

      // Блок 2
      {
        using console2 = logger.use();
        console2.log('log 2');
        rf3 = console2; // Сохраняем ссылку
      }
    }
  }

  // Блок 3 - утекшая ссылка
  {
    using rf4 = rf3;
    rf4.log('log 3'); // Не запишется
  }

  return rf3;
}

const rf4 = await main();
console.log('After main');
rf4.log('log 4'); // Не запишется
</code></pre>
<h3 id="example-8js"><a class="header" href="#example-8js">example-8.js</a></h3>
<pre><code class="language-javascript">import { MultiFileLogger } from './multi-file-logger.js';

const logger = new MultiFileLogger();

async function main() {
  let rf;

  // Блок 0
  {
    using c0 = logger.use('output.log');
    c0.log('log 0');

    // Блок 1
    {
      using c1 = logger.use('output.log');
      c1.log('log 1');

      // Блок 2
      {
        using c2 = logger.use('output.log');
        c2.log('log 2');

        // Блок 3 - другой файл
        {
          using c3 = logger.use('output3.log');
          c3.log('log 3');
        }

        rf = c2;
      }
    }
  }

  return rf;
}

// Блок 4
{
  const f1 = await main();
  using c4 = f1;
  c4.log('log 4'); // Не запишется
}

console.log('After main');

// Блок 5
{
  using c5 = f1;
  c5.log('log 5'); // Не запишется
}
</code></pre>
<hr>
<h2 id="ключевые-выводы"><a class="header" href="#ключевые-выводы">Ключевые выводы</a></h2>
<h3 id="1-reference-counter-решает-важные-проблемы"><a class="header" href="#1-reference-counter-решает-важные-проблемы">1. Reference Counter решает важные проблемы</a></h3>
<p>✓ <strong>Автоматическое управление ресурсами:</strong> не нужно вручную отслеживать открытие/закрытие
✓ <strong>Безопасность при исключениях:</strong> ресурсы освобождаются даже при ошибках
✓ <strong>Защита от утечек:</strong> невозможно забыть закрыть ресурс
✓ <strong>Детерминированность:</strong> ресурсы освобождаются сразу, а не когда-нибудь</p>
<h3 id="2-usingdisposable-vs-finalization-registry"><a class="header" href="#2-usingdisposable-vs-finalization-registry">2. Using/Disposable vs Finalization Registry</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Using/Disposable</th><th>Finalization Registry</th></tr>
</thead>
<tbody>
<tr><td>Детерминированное освобождение</td><td>Недетерминированное</td></tr>
<tr><td>Гарантия вызова</td><td>Может не вызваться</td></tr>
<tr><td>Мгновенное освобождение</td><td>Задержка до GC</td></tr>
<tr><td>Рекомендуется для критичных ресурсов</td><td>Только для некритичных случаев</td></tr>
</tbody>
</table>
</div>
<h3 id="3-практические-советы"><a class="header" href="#3-практические-советы">3. Практические советы</a></h3>
<p><strong>Делайте:</strong></p>
<ul>
<li>Используйте <code>using</code> для файлов, соединений, транзакций</li>
<li>Обрабатывайте ошибки в методе <code>dispose</code></li>
<li>Проверяйте поддержку <code>Symbol.dispose</code> в целевой среде</li>
</ul>
<p><strong>Не делайте:</strong></p>
<ul>
<li>Не сохраняйте ссылки на disposable объекты вне блока <code>using</code></li>
<li>Не используйте текущую реализацию Reference Counter в продакшене (пока это прототип)</li>
<li>Не полагайтесь на Finalization Registry для критичных ресурсов</li>
</ul>
<h3 id="4-статус-технологии"><a class="header" href="#4-статус-технологии">4. Статус технологии</a></h3>
<p>⚠️ <strong>Текущий статус:</strong> Прототип, экспериментальная реализация</p>
<p><strong>Доступность:</strong></p>
<ul>
<li>Node.js v24+</li>
<li>Современные версии Chrome</li>
<li>Требует проверки поддержки</li>
</ul>
<p><strong>Будущее:</strong></p>
<ul>
<li>Доработка и тестирование</li>
<li>Возможное включение в Metarhia technology stack</li>
<li>Создание библиотеки с готовыми классами</li>
</ul>
<hr>
<h2 id="дополнительные-материалы"><a class="header" href="#дополнительные-материалы">Дополнительные материалы</a></h2>
<h3 id="полезные-ссылки"><a class="header" href="#полезные-ссылки">Полезные ссылки</a></h3>
<ul>
<li><a href="https://github.com/tc39/proposal-explicit-resource-management">TC39 Proposal: Explicit Resource Management</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/dispose">MDN: Symbol.dispose</a></li>
<li>Исходники примеров под видео лекции</li>
</ul>
<h3 id="связанные-темы-для-изучения"><a class="header" href="#связанные-темы-для-изучения">Связанные темы для изучения</a></h3>
<ol>
<li><strong>Finalization Registry</strong> - альтернативный подход к управлению ресурсами</li>
<li><strong>WeakRef и WeakMap</strong> - слабые ссылки в JavaScript</li>
<li><strong>Try…finally</strong> - классический подход к освобождению ресурсов</li>
<li><strong>RAII (Resource Acquisition Is Initialization)</strong> - паттерн из C++, вдохновивший using/disposable</li>
<li><strong>Async Disposable</strong> - асинхронная версия disposable (Symbol.asyncDispose)</li>
</ol>
<h3 id="практические-задания"><a class="header" href="#практические-задания">Практические задания</a></h3>
<ol>
<li>Реализуйте Reference Counter для пула соединений к базе данных</li>
<li>Создайте систему блокировок (locks) с автоматическим освобождением</li>
<li>Реализуйте файловый кеш с автоматической очисткой</li>
<li>Добавьте поддержку async dispose для асинхронных ресурсов</li>
</ol>
<hr>
<h2 id="заключение"><a class="header" href="#заключение">Заключение</a></h2>
<p>Механизм <strong>using/disposable</strong> представляет собой мощный инструмент для управления жизненным циклом ресурсов в JavaScript. В сочетании с паттерном <strong>Reference Counter</strong>, он позволяет создавать надежные и безопасные абстракции для работы с файлами, соединениями и другими критичными ресурсами.</p>
<p><strong>Основные преимущества подхода:</strong></p>
<ul>
<li>Детерминированное освобождение ресурсов</li>
<li>Автоматическая защита от утечек</li>
<li>Краткий и понятный синтаксис</li>
<li>Безопасность при исключениях</li>
</ul>
<p><strong>Текущие ограничения:</strong></p>
<ul>
<li>Относительно новая технология</li>
<li>Требует поддержки современных версий платформ</li>
<li>Прототипная реализация Reference Counter не готова для продакшена</li>
</ul>
<p>Следите за развитием технологии и экспериментируйте с примерами, чтобы быть готовыми к ее широкому применению в будущем!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../week2/конспект-using-dispose.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../week3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../week2/конспект-using-dispose.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../week3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
