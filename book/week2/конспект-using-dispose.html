<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Disposable - Patterns</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-14213fa4.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-d959ff8c.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Patterns</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="явное-управление-ресурсами-при-помощи-using-и-symboldispose-в-javascript-typescript-nodejs"><a class="header" href="#явное-управление-ресурсами-при-помощи-using-и-symboldispose-в-javascript-typescript-nodejs">Явное управление ресурсами при помощи Using и Symbol.dispose в JavaScript, TypeScript, Node.js</a></h1>
<h2 id="обзор"><a class="header" href="#обзор">Обзор</a></h2>
<p>Данная лекция посвящена новым механизмам явного управления ресурсами в JavaScript и TypeScript. Основные темы включают:</p>
<ul>
<li>Новые символы <code>Symbol.dispose</code> и <code>Symbol.asyncDispose</code></li>
<li>Конструкции <code>using</code> и <code>await using</code></li>
<li>Сравнение с традиционными подходами (try/finally, Finalization Registry)</li>
<li>Синхронное и асинхронное освобождение ресурсов</li>
<li>Практические примеры и вложенные контексты</li>
</ul>
<hr>
<h2 id="содержание"><a class="header" href="#содержание">Содержание</a></h2>
<ol>
<li><a href="#введение-зачем-нужно-управление-ресурсами">Введение: зачем нужно управление ресурсами</a></li>
<li><a href="#традиционный-подход-tryfinally">Традиционный подход: try/finally</a></li>
<li><a href="#finalization-registry">Finalization Registry</a></li>
<li><a href="#новый-подход-using-и-symboldispose">Новый подход: using и Symbol.dispose</a></li>
<li><a href="#асинхронное-освобождение-await-using">Асинхронное освобождение: await using</a></li>
<li><a href="#различия-между-синхронным-и-асинхронным-dispose">Различия между синхронным и асинхронным dispose</a></li>
<li><a href="#вложенные-контексты">Вложенные контексты</a></li>
<li><a href="#порядок-вызова-dispose">Порядок вызова dispose</a></li>
<li><a href="#резюме">Резюме</a></li>
</ol>
<hr>
<h2 id="введение-зачем-нужно-управление-ресурсами"><a class="header" href="#введение-зачем-нужно-управление-ресурсами">Введение: зачем нужно управление ресурсами</a></h2>
<h3 id="проблематика"><a class="header" href="#проблематика">Проблематика</a></h3>
<p>При работе с ресурсами (файлы, сетевые соединения, базы данных) необходимо обеспечить их корректное освобождение:</p>
<ul>
<li>Предотвратить утечки памяти</li>
<li>Закрыть файловые дескрипторы</li>
<li>Освободить системные ресурсы</li>
<li>Обработать ошибки при освобождении</li>
</ul>
<p><strong>Ключевой момент</strong>: ресурс нужно освободить независимо от того, была ли ошибка во время его использования.</p>
<hr>
<h2 id="традиционный-подход-tryfinally"><a class="header" href="#традиционный-подход-tryfinally">Традиционный подход: try/finally</a></h2>
<h3 id="пример-работа-с-логером-через-tryfinally"><a class="header" href="#пример-работа-с-логером-через-tryfinally">Пример: работа с логером через try/finally</a></h3>
<pre><code class="language-javascript">async function usingSection() {
  let logger = null;

  try {
    // Создание ресурса (может выбросить ошибку)
    logger = await new Logger('./app.log');

    // Использование ресурса (может выбросить ошибку)
    await logger.write('Starting application...');
    await logger.write('Processing data...');

  } catch (error) {
    console.error('Error occurred:', error);

  } finally {
    // Обязательная очистка ресурса
    if (logger) {
      await logger.close();
      console.log('Logger closed in finally block');
    }
  }
}
</code></pre>
<h3 id="недостатки-традиционного-подхода"><a class="header" href="#недостатки-традиционного-подхода">Недостатки традиционного подхода</a></h3>
<ol>
<li><strong>Громоздкость</strong>: требуется явная проверка существования ресурса</li>
<li><strong>Дублирование кода</strong>: логика очистки повторяется для каждого ресурса</li>
<li><strong>Сложность</strong>: при множественных ресурсах код становится трудночитаемым</li>
<li><strong>Ошибки</strong>: легко забыть добавить finally или проверку на null</li>
</ol>
<p><strong>Пример проблемы с несколькими ресурсами:</strong></p>
<pre><code class="language-javascript">async function multipleResources() {
  let connection = null;
  let file = null;
  let cache = null;

  try {
    connection = await openDatabase();
    file = await openFile('./data.txt');
    cache = await createCache();

    // Работа с ресурсами...

  } finally {
    // Нужно закрыть все ресурсы в обратном порядке
    if (cache) await cache.flush();
    if (file) await file.close();
    if (connection) await connection.close();
  }
}
</code></pre>
<hr>
<h2 id="finalization-registry"><a class="header" href="#finalization-registry">Finalization Registry</a></h2>
<h3 id="концепция"><a class="header" href="#концепция">Концепция</a></h3>
<p><code>FinalizationRegistry</code> — это механизм, позволяющий выполнить код при сборке мусора, когда на объект больше нет ссылок.</p>
<h3 id="пример-использования"><a class="header" href="#пример-использования">Пример использования</a></h3>
<pre><code class="language-javascript">// Создание глобального реестра финализации
const registry = new FinalizationRegistry((resource) =&gt; {
  console.log('Finalization callback triggered');
  if (resource &amp;&amp; resource.close) {
    resource.close();
    console.log('File closed by FinalizationRegistry');
  }
});

class Logger {
  #handle;

  constructor(path) {
    this.#handle = fs.openSync(path, 'a');

    // Регистрация ресурса для автоматической очистки
    registry.register(
      this,           // Объект, за которым следим
      this.#handle    // Данные для callback
    );
  }

  write(message) {
    fs.writeSync(this.#handle, message + '\n');
  }
}

// Использование
function example() {
  const logger = new Logger('./app.log');
  logger.write('Message');
  // logger выходит из области видимости
}

example();

// Принудительный вызов сборщика мусора (только с флагом --expose-gc)
if (global.gc) {
  global.gc();
}
</code></pre>
<h3 id="запуск-с-флагом-expose-gc"><a class="header" href="#запуск-с-флагом-expose-gc">Запуск с флагом expose-gc</a></h3>
<pre><code class="language-bash"># Для запуска с возможностью ручного вызова GC
node --expose-gc example1-finalization.js
</code></pre>
<h3 id="проблемы-finalizationregistry"><a class="header" href="#проблемы-finalizationregistry">Проблемы FinalizationRegistry</a></h3>
<ol>
<li><strong>Непредсказуемость</strong>: нельзя точно знать, когда вызовется callback</li>
<li><strong>Задержки</strong>: GC может не запуститься долгое время</li>
<li><strong>Нет гарантий</strong>: callback может вообще не вызваться</li>
<li><strong>Зависимость от памяти</strong>: пока есть свободная память, GC не торопится</li>
<li><strong>Старые объекты</strong>: объекты в old generation собираются редко</li>
</ol>
<p><strong>Важно</strong>: FinalizationRegistry НЕ подходит для критичных ресурсов (файлы, соединения), которые нужно закрыть немедленно.</p>
<hr>
<h2 id="новый-подход-using-и-symboldispose"><a class="header" href="#новый-подход-using-и-symboldispose">Новый подход: using и Symbol.dispose</a></h2>
<h3 id="основная-идея"><a class="header" href="#основная-идея">Основная идея</a></h3>
<p>Конструкция <code>using</code> автоматически вызывает метод <code>Symbol.dispose</code> при выходе из блока видимости, где объявлена переменная.</p>
<h3 id="базовый-пример"><a class="header" href="#базовый-пример">Базовый пример</a></h3>
<pre><code class="language-javascript">class Logger {
  #handle;

  constructor(path) {
    this.#handle = fs.openSync(path, 'a');
    console.log(`Logger created for ${path}`);
  }

  write(message) {
    fs.writeSync(this.#handle, message + '\n');
  }

  // Метод для синхронного освобождения ресурса
  [Symbol.dispose]() {
    console.log('Disposing logger (sync)');
    if (this.#handle) {
      fs.closeSync(this.#handle);
      console.log('File closed');
    }
  }
}

// Использование с using
function main() {
  using logger = new Logger('./app.log');

  logger.write('Application started');
  logger.write('Processing...');

  // При выходе из функции автоматически вызовется logger[Symbol.dispose]()
}

main();
console.log('After main completed');
</code></pre>
<h3 id="как-это-работает"><a class="header" href="#как-это-работает">Как это работает</a></h3>
<ol>
<li><strong>Объявление</strong>: <code>using logger = new Logger(...)</code> создает ресурс</li>
<li><strong>Использование</strong>: работаем с ресурсом в пределах блока</li>
<li><strong>Автоматическая очистка</strong>: при достижении закрывающей скобки <code>}</code> вызывается <code>logger[Symbol.dispose]()</code></li>
<li><strong>Гарантия выполнения</strong>: dispose вызывается даже при ошибках</li>
</ol>
<h3 id="эквивалентный-код-без-using"><a class="header" href="#эквивалентный-код-без-using">Эквивалентный код без using</a></h3>
<pre><code class="language-javascript">function main() {
  const logger = new Logger('./app.log');

  try {
    logger.write('Application started');
    logger.write('Processing...');
  } finally {
    logger[Symbol.dispose]();
  }
}
</code></pre>
<h3 id="ключевые-особенности-using"><a class="header" href="#ключевые-особенности-using">Ключевые особенности using</a></h3>
<p><strong>1. Привязка к области видимости</strong></p>
<pre><code class="language-javascript">function example() {
  using resource = createResource();

  // resource доступен здесь
  console.log('Using resource');

} // &lt;-- resource[Symbol.dispose]() вызывается ЗДЕСЬ
</code></pre>
<p><strong>2. Работа с блоками</strong></p>
<pre><code class="language-javascript">function blockScopes() {
  console.log('Start');

  {
    using temp = createTempResource();
    console.log('Inside block');
  } // temp.dispose() вызывается здесь

  console.log('After block');
}
</code></pre>
<p><strong>3. Передача ссылки не влияет на dispose</strong></p>
<pre><code class="language-javascript">let externalRef;

function example() {
  using resource = createResource();
  externalRef = resource; // Сохранили ссылку во внешней переменной

} // resource[Symbol.dispose]() ВСЁ РАВНО вызовется здесь!

// externalRef теперь указывает на "disposed" объект
</code></pre>
<p><strong>Важное отличие от Finalization Registry</strong>: <code>using</code> освобождает ресурс при выходе из блока, а не при отсутствии ссылок!</p>
<hr>
<h2 id="асинхронное-освобождение-await-using"><a class="header" href="#асинхронное-освобождение-await-using">Асинхронное освобождение: await using</a></h2>
<h3 id="symbolasyncdispose"><a class="header" href="#symbolasyncdispose">Symbol.asyncDispose</a></h3>
<p>Для асинхронной очистки ресурсов используется <code>Symbol.asyncDispose</code> в комбинации с <code>await using</code>.</p>
<h3 id="пример-с-асинхронным-dispose"><a class="header" href="#пример-с-асинхронным-dispose">Пример с асинхронным dispose</a></h3>
<pre><code class="language-javascript">class AsyncLogger {
  #handle;
  #buffer = [];

  constructor(path) {
    this.#handle = fs.openSync(path, 'a');
    console.log(`AsyncLogger created`);
  }

  write(message) {
    this.#buffer.push(message);
  }

  // Асинхронный метод очистки
  async [Symbol.asyncDispose]() {
    console.log('Disposing logger (async)');

    // Шаг 1: Сбросить буфер в файл
    for (const msg of this.#buffer) {
      fs.writeSync(this.#handle, msg + '\n');
    }

    // Шаг 2: Закрыть файл
    fs.closeSync(this.#handle);

    // Шаг 3: Отправить уведомление (асинхронная операция)
    await this.sendNotification();

    console.log('Async disposal completed');
  }

  async sendNotification() {
    return new Promise(resolve =&gt; {
      setTimeout(() =&gt; {
        console.log('Notification sent');
        resolve();
      }, 100);
    });
  }
}

// Использование с await using
async function main() {
  await using logger = new AsyncLogger('./app.log');

  logger.write('Message 1');
  logger.write('Message 2');

  // При выходе ждем завершения logger[Symbol.asyncDispose]()
}

await main();
console.log('Auto dispose completed');
</code></pre>
<h3 id="зачем-нужен-асинхронный-dispose"><a class="header" href="#зачем-нужен-асинхронный-dispose">Зачем нужен асинхронный dispose?</a></h3>
<p>Асинхронный dispose позволяет:</p>
<ol>
<li><strong>Сбросить кэш</strong> в хранилище</li>
<li><strong>Отправить уведомления</strong> о закрытии ресурса</li>
<li><strong>Дождаться завершения</strong> фоновых операций</li>
<li><strong>Корректно закрыть</strong> сетевые соединения</li>
<li><strong>Запустить обработчики</strong> логов или метрик</li>
</ol>
<h3 id="пример-со-сложной-асинхронной-логикой"><a class="header" href="#пример-со-сложной-асинхронной-логикой">Пример со сложной асинхронной логикой</a></h3>
<pre><code class="language-javascript">class DatabaseConnection {
  #connection;

  async [Symbol.asyncDispose]() {
    console.log('Starting database cleanup...');

    // 1. Завершить активные транзакции
    await this.#connection.commitPendingTransactions();

    // 2. Сбросить кэш
    await this.#connection.flushCache();

    // 3. Закрыть соединение
    await this.#connection.close();

    // 4. Уведомить monitoring систему
    await this.notifyMonitoring('connection_closed');

    console.log('Database cleanup completed');
  }
}
</code></pre>
<hr>
<h2 id="различия-между-синхронным-и-асинхронным-dispose"><a class="header" href="#различия-между-синхронным-и-асинхронным-dispose">Различия между синхронным и асинхронным dispose</a></h2>
<h3 id="таблица-приоритетов"><a class="header" href="#таблица-приоритетов">Таблица приоритетов</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Конструкция</th><th>Есть Symbol.asyncDispose</th><th>Нет Symbol.asyncDispose</th></tr>
</thead>
<tbody>
<tr><td><code>await using</code></td><td>Вызывается <code>Symbol.asyncDispose</code></td><td>Вызывается <code>Symbol.dispose</code></td></tr>
<tr><td><code>using</code></td><td>Вызывается <code>Symbol.dispose</code></td><td>Вызывается <code>Symbol.dispose</code></td></tr>
</tbody>
</table>
</div>
<h3 id="правила-выбора-метода-dispose"><a class="header" href="#правила-выбора-метода-dispose">Правила выбора метода dispose</a></h3>
<p><strong>Правило 1</strong>: <code>await using</code> предпочитает асинхронный метод</p>
<pre><code class="language-javascript">class Resource {
  [Symbol.dispose]() {
    console.log('Sync dispose');
  }

  async [Symbol.asyncDispose]() {
    console.log('Async dispose');
  }
}

async function test() {
  await using r = new Resource();
} // Вызовется: Async dispose
</code></pre>
<p><strong>Правило 2</strong>: <code>using</code> всегда использует синхронный метод</p>
<pre><code class="language-javascript">async function test() {
  using r = new Resource(); // Даже если есть asyncDispose
} // Вызовется: Sync dispose
</code></pre>
<p><strong>Правило 3</strong>: Если нужного метода нет — ошибка</p>
<pre><code class="language-javascript">class NoDispose {
  // Нет ни Symbol.dispose, ни Symbol.asyncDispose
}

async function test() {
  await using r = new NoDispose();
  // TypeError: Cannot find Symbol.dispose method
}
</code></pre>
<h3 id="пример-проверка-всех-комбинаций"><a class="header" href="#пример-проверка-всех-комбинаций">Пример: проверка всех комбинаций</a></h3>
<pre><code class="language-javascript">// Пример 1: Оба метода определены, await using
class BothMethods {
  [Symbol.dispose]() {
    console.log('Sync dispose');
  }

  async [Symbol.asyncDispose]() {
    console.log('Async dispose');
  }
}

async function example1() {
  await using r = new BothMethods();
}
// Вывод: Async dispose

// Пример 2: Оба метода определены, using
function example2() {
  using r = new BothMethods();
}
// Вывод: Sync dispose

// Пример 3: Только sync dispose, await using
class OnlySync {
  [Symbol.dispose]() {
    console.log('Sync dispose');
  }
}

async function example3() {
  await using r = new OnlySync();
}
// Вывод: Sync dispose (откат к синхронному)

// Пример 4: Только async dispose, using
class OnlyAsync {
  async [Symbol.asyncDispose]() {
    console.log('Async dispose');
  }
}

function example4() {
  using r = new OnlyAsync();
  // ОШИБКА: не найден Symbol.dispose
}
</code></pre>
<hr>
<h2 id="порядок-вызова-dispose"><a class="header" href="#порядок-вызова-dispose">Порядок вызова dispose</a></h2>
<h3 id="важная-особенность-синхронного-dispose-с-await-внутри"><a class="header" href="#важная-особенность-синхронного-dispose-с-await-внутри">Важная особенность синхронного dispose с await внутри</a></h3>
<p>Если в синхронном <code>Symbol.dispose</code> используется <code>await</code>, выполнение разрывается!</p>
<h4 id="пример-4-разрыв-выполнения"><a class="header" href="#пример-4-разрыв-выполнения">Пример 4: Разрыв выполнения</a></h4>
<pre><code class="language-javascript">class Logger {
  [Symbol.dispose]() {
    console.log('Dispose: before await');

    await new Promise(resolve =&gt; setTimeout(resolve, 100));

    console.log('Dispose: after await');
  }
}

function main() {
  using logger = new Logger();
  console.log('Inside main');
}

main();
console.log('Auto dispose');
</code></pre>
<p><strong>Вывод:</strong></p>
<pre><code>Inside main
Dispose: before await
Auto dispose              &lt;-- Управление передалось сюда!
Dispose: after await      &lt;-- А это выполнится позже
</code></pre>
<p><strong>Объяснение</strong>: Синхронный dispose с <code>await</code> разрывается на две части. Управление передается дальше после первого <code>await</code>, не дожидаясь завершения dispose.</p>
<h4 id="пример-5-правильный-асинхронный-dispose"><a class="header" href="#пример-5-правильный-асинхронный-dispose">Пример 5: Правильный асинхронный dispose</a></h4>
<pre><code class="language-javascript">class Logger {
  async [Symbol.asyncDispose]() {
    console.log('Async dispose: before await');

    await new Promise(resolve =&gt; setTimeout(resolve, 100));

    console.log('Async dispose: after await');
  }
}

async function main() {
  await using logger = new Logger();
  console.log('Inside main');
}

await main();
console.log('Auto dispose');
</code></pre>
<p><strong>Вывод:</strong></p>
<pre><code>Inside main
Async dispose: before await
Async dispose: after await    &lt;-- Полностью выполнился
Auto dispose                   &lt;-- Только потом управление передалось
</code></pre>
<p><strong>Вывод</strong>: Используйте <code>Symbol.asyncDispose</code> с <code>await using</code>, если внутри dispose есть асинхронные операции!</p>
<hr>
<h2 id="вложенные-контексты"><a class="header" href="#вложенные-контексты">Вложенные контексты</a></h2>
<h3 id="порядок-освобождения-lifo-last-in-first-out"><a class="header" href="#порядок-освобождения-lifo-last-in-first-out">Порядок освобождения: LIFO (Last In, First Out)</a></h3>
<p>Ресурсы освобождаются в порядке стека — последний созданный освобождается первым.</p>
<h3 id="пример-с-вложенными-блоками"><a class="header" href="#пример-с-вложенными-блоками">Пример с вложенными блоками</a></h3>
<pre><code class="language-javascript">function createDisposable(id) {
  console.log(`Creating ${id}`);
  return {
    [Symbol.dispose]() {
      console.log(`Disposing ${id}`);
    }
  };
}

function nestedExample() {
  console.log('=== Start ===');

  using a = createDisposable('A');
  using b = createDisposable('B');

  {
    using c = createDisposable('C');
    using d = createDisposable('D');
    console.log('Inside inner block');
  } // &lt;-- D и C освобождаются здесь

  console.log('Back to outer block');

  using e = createDisposable('E');

  console.log('=== End ===');
} // &lt;-- E, B и A освобождаются здесь

nestedExample();
</code></pre>
<p><strong>Вывод:</strong></p>
<pre><code>=== Start ===
Creating A
Creating B
Creating C
Creating D
Inside inner block
Disposing D       &lt;-- Последний созданный в блоке
Disposing C       &lt;-- Первый созданный в блоке
Back to outer block
Creating E
=== End ===
Disposing E       &lt;-- Последний в функции
Disposing B       &lt;-- Второй в функции
Disposing A       &lt;-- Первый в функции
</code></pre>
<h3 id="асинхронный-пример-с-вложенностью"><a class="header" href="#асинхронный-пример-с-вложенностью">Асинхронный пример с вложенностью</a></h3>
<pre><code class="language-javascript">function loggy(id) {
  console.log(`Constructing ${id}`);
  return {
    async [Symbol.asyncDispose]() {
      console.log(`Disposing (async) ${id}`);
      await new Promise(resolve =&gt; setTimeout(resolve, 100));
    }
  };
}

async function func() {
  await using a = loggy('a');
  await using b = loggy('b');

  {
    await using c = loggy('c');
    await using d = loggy('d');
  } // c и d утилизируются здесь

  await using e = loggy('e');

  return;

  // Недостижимый код
  await using f = loggy('f'); // НЕ создастся, НЕ утилизируется
}

await func();
</code></pre>
<p><strong>Вывод:</strong></p>
<pre><code>Constructing a
Constructing b
Constructing c
Constructing d
Disposing (async) d
Disposing (async) c
Constructing e
Disposing (async) e
Disposing (async) b
Disposing (async) a
</code></pre>
<h3 id="визуализация-порядка"><a class="header" href="#визуализация-порядка">Визуализация порядка</a></h3>
<pre><code>Функция func():
┌─────────────────────────────────────┐
│ await using a                       │ ← Создан первым
│ await using b                       │ ← Создан вторым
│                                     │
│ ┌─────────────────────────────┐    │
│ │ Вложенный блок:             │    │
│ │ await using c               │    │ ← Создан третьим
│ │ await using d               │    │ ← Создан четвертым
│ │                             │    │
│ └─────────────────────────────┘    │
│   ↑ Dispose d (4)                   │
│   ↑ Dispose c (3)                   │
│                                     │
│ await using e                       │ ← Создан пятым
│                                     │
└─────────────────────────────────────┘
  ↑ Dispose e (5)
  ↑ Dispose b (2)
  ↑ Dispose a (1)
</code></pre>
<h3 id="перекрытие-идентификаторов-shadowing"><a class="header" href="#перекрытие-идентификаторов-shadowing">Перекрытие идентификаторов (shadowing)</a></h3>
<pre><code class="language-javascript">function shadowingExample() {
  using console = createDisposable('outer console');

  {
    using console = createDisposable('inner console');
    // Здесь доступен inner console
  } // inner console освобождается

  // Здесь снова доступен outer console
} // outer console освобождается
</code></pre>
<hr>
<h2 id="практические-сценарии-использования"><a class="header" href="#практические-сценарии-использования">Практические сценарии использования</a></h2>
<h3 id="сценарий-1-работа-с-файлами"><a class="header" href="#сценарий-1-работа-с-файлами">Сценарий 1: Работа с файлами</a></h3>
<pre><code class="language-javascript">class TempFile {
  #path;
  #handle;

  constructor(path) {
    this.#path = path;
    this.#handle = fs.openSync(path, 'w+');
    console.log(`Opened temp file: ${path}`);
  }

  write(data) {
    fs.writeSync(this.#handle, data);
  }

  read() {
    const stats = fs.fstatSync(this.#handle);
    const buffer = Buffer.alloc(stats.size);
    fs.readSync(this.#handle, buffer, 0, stats.size, 0);
    return buffer.toString();
  }

  [Symbol.dispose]() {
    fs.closeSync(this.#handle);
    fs.unlinkSync(this.#path);
    console.log(`Deleted temp file: ${this.#path}`);
  }
}

function processTempData() {
  using tempFile = new TempFile('./temp_data.tmp');

  tempFile.write('Important data');
  const content = tempFile.read();
  console.log('Content:', content);

  // Файл автоматически удалится при выходе
}
</code></pre>
<h3 id="сценарий-2-трассировка-выполнения"><a class="header" href="#сценарий-2-трассировка-выполнения">Сценарий 2: Трассировка выполнения</a></h3>
<pre><code class="language-javascript">class TraceActivity {
  #name;
  #startTime;

  constructor(name) {
    this.#name = name;
    this.#startTime = Date.now();
    console.log(`→ Entering: ${name}`);
  }

  [Symbol.dispose]() {
    const duration = Date.now() - this.#startTime;
    console.log(`← Exiting: ${this.#name} (${duration}ms)`);
  }
}

function businessLogic() {
  using _trace = new TraceActivity('businessLogic');

  // Бизнес-логика
  for (let i = 0; i &lt; 1000000; i++) {
    Math.sqrt(i);
  }
}

businessLogic();
// Вывод:
// → Entering: businessLogic
// ← Exiting: businessLogic (15ms)
</code></pre>
<h3 id="сценарий-3-управление-транзакциями"><a class="header" href="#сценарий-3-управление-транзакциями">Сценарий 3: Управление транзакциями</a></h3>
<pre><code class="language-javascript">class Transaction {
  #db;
  #committed = false;

  constructor(db) {
    this.#db = db;
    this.#db.begin();
    console.log('Transaction started');
  }

  commit() {
    this.#db.commit();
    this.#committed = true;
    console.log('Transaction committed');
  }

  [Symbol.dispose]() {
    if (!this.#committed) {
      this.#db.rollback();
      console.log('Transaction rolled back');
    }
  }
}

function updateDatabase(db) {
  using transaction = new Transaction(db);

  db.update('users', { name: 'John' });
  db.update('orders', { status: 'completed' });

  // Если ошибка — автоматический rollback
  if (someCondition()) {
    transaction.commit();
  }
  // Иначе — rollback при выходе
}
</code></pre>
<h3 id="сценарий-4-блокировки-и-мьютексы"><a class="header" href="#сценарий-4-блокировки-и-мьютексы">Сценарий 4: Блокировки и мьютексы</a></h3>
<pre><code class="language-javascript">class Lock {
  #resource;

  constructor(resource) {
    this.#resource = resource;
    resource.acquire();
    console.log('Lock acquired');
  }

  [Symbol.dispose]() {
    this.#resource.release();
    console.log('Lock released');
  }
}

function criticalSection(resource) {
  using lock = new Lock(resource);

  // Критическая секция — только один поток может быть здесь
  modifySharedData();

  // Блокировка автоматически освободится
}
</code></pre>
<hr>
<h2 id="reference-counting-предварительно"><a class="header" href="#reference-counting-предварительно">Reference Counting (предварительно)</a></h2>
<p>Лектор упоминает, что <code>using</code> <strong>не реализует автоматический подсчет ссылок</strong> (reference counting), как в некоторых других языках.</p>
<h3 id="что-это-значит"><a class="header" href="#что-это-значит">Что это значит?</a></h3>
<pre><code class="language-javascript">let externalRef;

function example() {
  using resource = createResource();
  externalRef = resource; // Создали дополнительную ссылку

} // resource.dispose() вызовется, даже если externalRef еще жива!

// externalRef теперь указывает на "мертвый" объект
</code></pre>
<p><strong>Планы</strong>: Лектор обещает отдельную лекцию о том, как реализовать reference counting поверх <code>using</code>.</p>
<hr>
<h2 id="совместимость-и-полифиллы"><a class="header" href="#совместимость-и-полифиллы">Совместимость и полифиллы</a></h2>
<h3 id="проверка-поддержки"><a class="header" href="#проверка-поддержки">Проверка поддержки</a></h3>
<pre><code class="language-javascript">// Проверка наличия Symbol.dispose
if (typeof Symbol.dispose === 'undefined') {
  // Полифилл
  Symbol.dispose = Symbol('Symbol.dispose');
}

if (typeof Symbol.asyncDispose === 'undefined') {
  Symbol.asyncDispose = Symbol('Symbol.asyncDispose');
}
</code></pre>
<h3 id="полифилл-от-typescript"><a class="header" href="#полифилл-от-typescript">Полифилл от TypeScript</a></h3>
<p>TypeScript предоставляет полифиллы для окружений без нативной поддержки:</p>
<pre><code class="language-typescript">Symbol.dispose ??= Symbol("Symbol.dispose");
Symbol.asyncDispose ??= Symbol("Symbol.asyncDispose");
</code></pre>
<h3 id="поддержка-в-рантаймах"><a class="header" href="#поддержка-в-рантаймах">Поддержка в рантаймах</a></h3>
<p>На момент записи лекции (упоминается в конце):</p>
<ul>
<li><strong>Node.js 24</strong>: Полная поддержка ✅</li>
<li><strong>Chrome/Chromium</strong>: Полная поддержка ✅</li>
<li><strong>TypeScript 5.2+</strong>: Полная поддержка ✅</li>
</ul>
<hr>
<h2 id="обработка-ошибок"><a class="header" href="#обработка-ошибок">Обработка ошибок</a></h2>
<h3 id="suppressederror"><a class="header" href="#suppressederror">SuppressedError</a></h3>
<p>Если ошибка происходит и в основном коде, и в <code>dispose</code>, создается специальный <code>SuppressedError</code>:</p>
<pre><code class="language-javascript">class ErrorThrower {
  [Symbol.dispose]() {
    throw new Error('Error in dispose');
  }
}

function test() {
  using resource = new ErrorThrower();
  throw new Error('Error in main code');
}

try {
  test();
} catch (e) {
  console.log(e.name);              // SuppressedError
  console.log(e.message);           // An error was suppressed during disposal
  console.log(e.error.message);     // Error in dispose
  console.log(e.suppressed.message); // Error in main code
}
</code></pre>
<h3 id="множественные-ошибки-dispose"><a class="header" href="#множественные-ошибки-dispose">Множественные ошибки dispose</a></h3>
<pre><code class="language-javascript">function multipleErrors() {
  using a = { [Symbol.dispose]() { throw new Error('A failed'); } };
  using b = { [Symbol.dispose]() { throw new Error('B failed'); } };
}

try {
  multipleErrors();
} catch (e) {
  // Обе ошибки будут собраны в цепочку SuppressedError
}
</code></pre>
<hr>
<h2 id="использование-в-циклах"><a class="header" href="#использование-в-циклах">Использование в циклах</a></h2>
<h3 id="for-loop"><a class="header" href="#for-loop">For loop</a></h3>
<pre><code class="language-javascript">function processFiles(files) {
  for (using file = openFile(files[0]); file.hasNext(); file.next()) {
    console.log(file.read());
  } // file закрывается после цикла
}
</code></pre>
<h3 id="forof-loop"><a class="header" href="#forof-loop">For…of loop</a></h3>
<pre><code class="language-javascript">function* createResources() {
  yield new Resource('A');
  yield new Resource('B');
  yield new Resource('C');
}

function processResources() {
  for (using resource of createResources()) {
    console.log(resource.use());
    // Каждый resource автоматически освобождается после итерации
  }
}
</code></pre>
<hr>
<h2 id="резюме"><a class="header" href="#резюме">Резюме</a></h2>
<h3 id="основные-концепции"><a class="header" href="#основные-концепции">Основные концепции</a></h3>
<ol>
<li>
<p><strong><code>using</code> объявление</strong></p>
<ul>
<li>Автоматически вызывает <code>Symbol.dispose</code> при выходе из блока</li>
<li>Работает синхронно</li>
<li>Гарантирует освобождение ресурса даже при ошибках</li>
</ul>
</li>
<li>
<p><strong><code>await using</code> объявление</strong></p>
<ul>
<li>Автоматически вызывает <code>Symbol.asyncDispose</code> при выходе из блока</li>
<li>Ожидает завершения асинхронной очистки</li>
<li>Откатывается к <code>Symbol.dispose</code>, если асинхронного метода нет</li>
</ul>
</li>
<li>
<p><strong>Порядок освобождения</strong></p>
<ul>
<li>LIFO (Last In, First Out) — стековый порядок</li>
<li>Вложенные контексты освобождаются корректно</li>
</ul>
</li>
<li>
<p><strong>Отличия от других подходов</strong></p>
<ul>
<li><strong>vs try/finally</strong>: Меньше кода, автоматическая очистка</li>
<li><strong>vs FinalizationRegistry</strong>: Детерминированное время освобождения</li>
<li><strong>vs GC</strong>: Явный контроль, не зависит от сборщика мусора</li>
</ul>
</li>
</ol>
<h3 id="когда-использовать"><a class="header" href="#когда-использовать">Когда использовать</a></h3>
<p>✅ <strong>Используйте <code>using</code>:</strong></p>
<ul>
<li>Файловые дескрипторы</li>
<li>Сетевые соединения</li>
<li>Блокировки и мьютексы</li>
<li>Временные ресурсы</li>
<li>Трассировка и профилирование</li>
</ul>
<p>✅ <strong>Используйте <code>await using</code>:</strong></p>
<ul>
<li>Когда нужно дождаться асинхронной очистки</li>
<li>Сброс кэша в БД</li>
<li>Отправка метрик</li>
<li>Корректное закрытие соединений</li>
</ul>
<p>❌ <strong>Не используйте для:</strong></p>
<ul>
<li>Обычных объектов без внешних ресурсов</li>
<li>Объектов, управляемых GC</li>
<li>Ситуаций, где нужен reference counting (требует доп. обертки)</li>
</ul>
<h3 id="преимущества"><a class="header" href="#преимущества">Преимущества</a></h3>
<ul>
<li><strong>Читаемость</strong>: Меньше boilerplate кода</li>
<li><strong>Надежность</strong>: Автоматическая очистка даже при ошибках</li>
<li><strong>Предсказуемость</strong>: Детерминированное время освобождения</li>
<li><strong>Композируемость</strong>: Легко работать с множественными ресурсами</li>
</ul>
<h3 id="ограничения"><a class="header" href="#ограничения">Ограничения</a></h3>
<ul>
<li>Нет автоматического reference counting</li>
<li>Требует явной реализации <code>Symbol.dispose</code> / <code>Symbol.asyncDispose</code></li>
<li>Относительно новая возможность (Node.js 24+, современные браузеры)</li>
</ul>
<h3 id="дальнейшее-изучение"><a class="header" href="#дальнейшее-изучение">Дальнейшее изучение</a></h3>
<p>Лектор обещает следующие темы:</p>
<ol>
<li><strong>Reference Counting</strong> — реализация подсчета ссылок поверх <code>using</code></li>
<li><strong>Расширенные паттерны</strong> — сложные сценарии использования</li>
<li><strong>Интеграция с фреймворками</strong> — примеры из реальных проектов</li>
</ol>
<hr>
<h2 id="полезные-ссылки"><a class="header" href="#полезные-ссылки">Полезные ссылки</a></h2>
<h3 id="документация"><a class="header" href="#документация">Документация</a></h3>
<ul>
<li><a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-2.html">TypeScript 5.2 Release Notes - using</a></li>
<li><a href="https://github.com/tc39/proposal-explicit-resource-management">ECMAScript Explicit Resource Management Proposal</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">MDN: FinalizationRegistry</a></li>
</ul>
<h3 id="флаги-для-запуска-примеров"><a class="header" href="#флаги-для-запуска-примеров">Флаги для запуска примеров</a></h3>
<pre><code class="language-bash"># Включить ручной вызов Garbage Collection
node --expose-gc script.js

# Проверить версию Node.js
node --version  # Должна быть 24+
</code></pre>
<h3 id="типы-typescript"><a class="header" href="#типы-typescript">Типы TypeScript</a></h3>
<pre><code class="language-typescript">interface Disposable {
  [Symbol.dispose](): void;
}

interface AsyncDisposable {
  [Symbol.asyncDispose](): void | Promise&lt;void&gt;;
}
</code></pre>
<hr>
<h2 id="практические-задания"><a class="header" href="#практические-задания">Практические задания</a></h2>
<h3 id="задание-1-базовое-использование"><a class="header" href="#задание-1-базовое-использование">Задание 1: Базовое использование</a></h3>
<p>Создайте класс <code>DatabaseConnection</code> с методом <code>Symbol.dispose</code>, который логирует закрытие соединения.</p>
<h3 id="задание-2-асинхронная-очистка"><a class="header" href="#задание-2-асинхронная-очистка">Задание 2: Асинхронная очистка</a></h3>
<p>Реализуйте класс <code>CachedLogger</code>, который при dispose:</p>
<ol>
<li>Сбрасывает буфер в файл</li>
<li>Закрывает файл</li>
<li>Отправляет метрики (асинхронно)</li>
</ol>
<h3 id="задание-3-вложенные-контексты"><a class="header" href="#задание-3-вложенные-контексты">Задание 3: Вложенные контексты</a></h3>
<p>Напишите функцию с вложенными <code>using</code> блоками и проверьте порядок освобождения.</p>
<h3 id="задание-4-обработка-ошибок"><a class="header" href="#задание-4-обработка-ошибок">Задание 4: Обработка ошибок</a></h3>
<p>Создайте класс, который выбрасывает ошибку в <code>dispose</code>, и обработайте <code>SuppressedError</code>.</p>
<hr>
<h2 id="заключение"><a class="header" href="#заключение">Заключение</a></h2>
<p>Механизм явного управления ресурсами через <code>using</code> и <code>Symbol.dispose</code> — это мощное дополнение к JavaScript/TypeScript, которое:</p>
<ul>
<li>Делает код чище и безопаснее</li>
<li>Гарантирует освобождение ресурсов</li>
<li>Упрощает работу со сложными сценариями</li>
<li>Приближает JavaScript к языкам с RAII (Resource Acquisition Is Initialization)</li>
</ul>
<p>Начинайте использовать эту возможность в новых проектах уже сейчас!</p>
<hr>
<p><strong>Дата создания конспекта</strong>: 2025-12-09
<strong>Версия Node.js</strong>: 24+
<strong>Версия TypeScript</strong>: 5.2+</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../week2/promise-contract-lecture-notes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../week2/reference-counter-using-disposable.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../week2/promise-contract-lecture-notes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../week2/reference-counter-using-disposable.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
